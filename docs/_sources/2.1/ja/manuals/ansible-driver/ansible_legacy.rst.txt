=========================
Ansible-Legacy
=========================

はじめに
========

| 本書では、ITAの機能および操作方法について説明します。

Ansible driver概要
==================

.. include:: ../../include/ansible_option_ansible-driver_overview.rst

| Ansible driverには用途に応じて以下3つのモードを用意しています。

#. | **Legacy モード**
   | Ansible標準の機能を用いて各種ホストへ設定を投入します。
   | 構築コードを単体YAMLファイルとして登録し、作業パターンをその組み合わせで構成します。
   | OS,NWの環境設定などの作業用に使われることを想定します。
   
#. | **Legacy Role モード**
   | Legacyモードと同じく、Ansible標準の機能を用いて各種ホストへ設定を投入します。
   | 構築コードをパッケージとして登録し、作業パターンをRoleの組み合わせで構成します。
   | 製品部門などが提供するRoleパッケージを用いて、製品のインストール、環境構築などを行う際に使われることを想定します。

#. | **Pioneer モード**
   | Ansibleに独自モジュールを追加し、対話形式による設定投入を可能とします。
   | サーバ、ストレージ、ネットワークを問わず、Telnet, SSH でログイン可能なあらゆる機器に対応しています。対象機器と直接やり取りが必要となるため、相応のＩＴスキルが必要となります。


| また、Ansible driverは、Playbook中の変数を画面から設定することができます。詳細は本書「 :ref:`ansible_legacy_variable_handling_in_ansible_driver` 」を参照してください。


.. _ansible_legacy_variable_handling_in_ansible_driver:

Ansible driverでの変数取り扱い
==============================

変数の種類
----------

| Ansible driverでは、Playbook中の変数の具体値をITAの設定画面から設定することができます。
| **※設定方法の詳細は、本書「** :ref:`ansible_legacy_substitution_value_auto_registration_setting` **」を参照してください。**
| Playbook中の変数で、ITAの変数として扱える変数は以下の6種類があります。


通常変数
--------

.. include:: ../../include/ansible_option_normal-variable.rst


複数具体値変数
--------------

.. include:: ../../include/ansible_option_multiple-specific-value-variable.rst


グローバル変数
--------------

.. include:: ../../include/ansible_option_global-variable.rst


テンプレート埋込変数
--------------------

.. include:: ../../include/ansible_option_template-embedded-variable.rst


ファイル埋込変数
----------------

.. include:: ../../include/ansible_option_fle-embedded-varaible.rst

ITA独自変数
-----------

.. include:: ../../include/ansible_option_ita-original-variable.rst


変数の抜出および具体値登録
--------------------------

| 各モードとも、ITAにアップロードしたPlaybook等の資材から変数を抜出し、各メニューから具体値を登録できます。各メニューから登録した変数の具体値は、作業実行時にホスト変数ファイルに出力されます。
| 変数の抜出方法は以下のとおりです。

| **Ansible-Legacy**
| 「Playbook素材集 (本書： :ref:`ansible_legacy_playbook_file_list_ansible_legacy_only` )」でアップロードしたPlaybookより、以下の書式の変数定義を抜出します。


.. table::  変数の抜出および具体値登録
   :widths: 4 8 16
   :align: left

   +-------------------------------+--------------------------------------+------------------------------------------------------------------------------------------+
   | 変数名                        | 書式                                 | 具体値の設定                                                                             |
   |                               |                                      |                                                                                          |
   +===============================+======================================+==========================================================================================+
   | 通常変数                      | .. code-block:: yaml                 | 具体値の登録は「 :ref:`ansible_legacy_substitution_value_auto_registration_setting` 」\  |
   |                               |                                      | や「 :ref:`ansible_legacy_substitution_value_list` 」メニューより行います。              |
   | 複数具体値変数                |    {{ VAR_xxx }}                     |                                                                                          |
   |                               |                                      | 具体値の登録の仕方で通常変数か複数具体値変数かを決定します。                             |
   |                               |    {{ VAR_xxx | フィルタ }}          |                                                                                          |
   +-------------------------------+--------------------------------------+------------------------------------------------------------------------------------------+
   | グローバル変数                | .. code-block:: yaml                 | 具体値の登録は「 :ref:`ansible_legacy_global_variable_list` 」メニューより行います。     |
   |                               |                                      |                                                                                          |
   |                               |    {{ GBL_xxx }}                     |                                                                                          |
   |                               |                                      |                                                                                          |
   |                               |    {{ GBL_xxx | フィルタ }}          |                                                                                          |
   +-------------------------------+--------------------------------------+------------------------------------------------------------------------------------------+
   | テンプレート埋込変数          | .. code-block:: yaml                 | 具体値の登録は「 :ref:`ansible_legacy_template_list` 」メニューより行います。            |
   |                               |                                      |                                                                                          |
   |                               |    {{ TPF_xxx }}                     |                                                                                          |
   |                               |                                      |                                                                                          |
   |                               |    {{ TPF_xxx | フィルタ }}          |                                                                                          |
   +-------------------------------+--------------------------------------+------------------------------------------------------------------------------------------+
   | ファイル埋込変数              | .. code-block:: yaml                 | 具体値の登録は「 :ref:`ansible_legacy_file_list` 」メニューより行います。                |
   |                               |                                      |                                                                                          |
   |                               |    {{ CPF_xxx }}                     |                                                                                          |
   |                               |                                      |                                                                                          |
   |                               |    {{ CPF_xxx | フィルタ }}          |                                                                                          |
   +-------------------------------+--------------------------------------+------------------------------------------------------------------------------------------+


代入値登録による変数の扱い
--------------------------

| Playbookで定義した変数の値は代入値登録機能により上書きすることができます。
| Playbook中の変数と、代入値管理機能で登録した変数の値の関係を、以下の図に示します。

.. image:: /images/ja/diagram/hensu.png
   :width: 6.68819in
   :height: 3.35972in

| 代入値管理機能で登録した変数の値は、各ホスト用に変数定義ファイル(host_vars)に出力され、Ansibleで元のPlaybookと変数定義用ファイルを入力として各ホストに実行されます。
| この結果、変数の値の優先順位は以下のようになります。

#. | 代入値管理機能で登録した値
#. | Playbook中の変数に指定した値
   | 詳細は 「 :ref:`ansible_legacy_substitution_value_list` 」を参照してください。


Ansible driver コンソールメニュー構成
=====================================

| 本章では、ITA コンソールのメニュー構成について説明します。

メニュー/画面一覧
-----------------

1. | **基本コンソールのメニュー**

.. include:: ../../include/ansible_option_basic-console-menu.rst

|

2. | **Ansible共通コンソールのメニュー**

.. include:: ../../include/ansible_option_ansible-common-console-menu.rst

|

3. | **Ansible-Legacyコンソールのメニュー**

| Ansible-Legacyコンソールに対応するメニュー一覧を以下に記述します。

.. list-table::  Ansible-Legacyコンソール メニュー/画面一覧
   :widths: 20 30 80
   :header-rows: 1
   :align: left

   * - No
     - メニュー・画面
     - 説明 
   * - 1
     - Movement一覧
     - Movementの一覧を管理します。
   * - 2
     - Playbook素材集
     - Playbookファイルを管理します。
   * - 3
     - Movement-Playbook紐付
     - MovementとPlaybookの関連付けを管理します。 
   * - 4
     - Movement-変数紐付 (※1)
     - Movementで使用している変数を管理します。
   * - 5
     - 代入値自動登録設定 
     - CMDBのメニューに登録されているオぺレーションとホスト毎の項目値を紐付けるMovementと変数を管理します。
   * - 6
     - 作業実行
     - 作業実行するMovementとオペレーションを選択し実行を指示します。
   * - 7
     - 作業管理  
     - 作業実行履歴を管理します。   
   * - 8
     - 作業状態確認 
     - 作業実行状態を表示します。 
   * - 9
     - 作業対象ホスト 
     - Movementで使用するホストを管理します。
   * - 10
     - 代入値管理
     - 変数の代入値を管理します。  



.. note:: | ※1 非表示メニューは、バックヤード機能でデータの登録・更新を行うメニューです。
   | Ansible Driver機能をインストールした状態では表示されないメニューに設定されています。
   | 非表示メニューを表示するには、:menuselection:`管理コンソール-->ロール・メニュー紐付管理` で各メニューの復活処理を行います。詳細は :doc:`../it_automation_base/management_console` を参照してください。


Ansible driver利用手順
======================

| Ansibleコンソールの利用手順について説明します。


Ansible-Legacy作業フロー
~~~~~~~~~~~~~~~~~~~~~~~~
| 以下は、Ansible-Legacyで作業を実行するまでの流れです。

-  **作業フロー詳細と参照先**
  
   #. | **機器情報にAnsible利用情報を設定**
      | ITA基本コンソールの機器一覧の画面から、各機器に対してAnsible利用情報を設定します。
      | 詳細は :ref:`ansible_legacy_device_list` を参照してください。

   #. | **投入オペレーション名の登録**
      | ITA基本コンソールのオペレーション一覧の画面から、作業用の投入オペレーション名を登録します。
      | 詳細は :ref:`ansible_legacy_input_operation_list` を参照してください。

   #. | **インターフェース情報の登録**
      | Ansible共通コンソールのインターフェース情報の画面から、Ansible Core、Ansible Automation Controllerサーバのどちらを実行エンジンにするかを選択し、実行エンジンのサーバへの接続情報の登録します。
      | 詳細は :ref:`ansible_legacy_interface_information` を参照してください。

   #. | **作業パターン(Movement)の登録**
      | Ansible-LegacyコンソールのMovement一覧の画面から、作業用のMovementを登録します。
      | 詳細は :ref:`ansible_legacy_movement_list` を参照してください。

   #. | **Playbookの登録**
      | Ansible-LegacyコンソールのPlaybook素材集の画面から、作業で使用するPlaybookを登録します。
      | 詳細は :ref:`ansible_legacy_playbook_file_list_ansible_legacy_only` を参照してください。

   #. | **テンプレートファイルの登録（必要に応じて実施）**
      | Ansible共通コンソールのテンプレート管理の画面から、Playbook内のtemplateモジュールなどで使用しているtemplateファイル(src)とtemplate埋め込み変数の登録／更新／廃止を行います。
      | 詳細は :ref:`ansible_legacy_template_list` を参照してください。

   #. | **素材ファイルの登録 （必要に応じて実施）**
      | Ansible共通コンソールのファイル管理の画面から、作業対象サーバに配置するファイルを登録します。
      | 詳細は :ref:`ansible_legacy_file_list` を参照してください。

   #. | **Movementにプレイブック素材を指定**
      | Ansible-LegacyコンソールのMovement-Playbook紐付（Movement-対話種別紐付、Movement-ロール紐付）の画面から、登録したMovementにプレイブック素材を指定します。
      | 詳細は :ref:`ansible_legacy_movement_details` を参照してください。

   #. | **作業対象ホストの指定**
      | Ansible-Legacyコンソールの作業対象ホストの画面から、作業対象ホストを指定します。
      | 詳細は :ref:`ansible_legacy_target_host` を参照してください。

   #. | **変数値の設定（必要に応じて実施）**
      | Ansible-Legacyコンソールの代入値管理の画面から、Movementに登録したPlaybook内で定義した変数の値を設定します。変数を利用していない場合、設定は不要です。
      | 詳細は :ref:`ansible_legacy_substitution_value_list` を参照してください。

   #. | **作業実行**
      | Ansible-Legacyコンソールの作業実行の画面から、実行日時、投入オペレーションを選択して設定して処理の実行を指示します。
      | 詳細は :ref:`ansible_legacy_execution` を参照してください。

   #. | **作業状態確認** 
      | Ansible-Legacyコンソールの作業状態確認の画面では、実行した作業の状態がリアルタイムで表示されます。また、作業の緊急停止や、実行ログ、エラーログを監視することができます。
      | 詳細は :ref:`ansible_legacy_check_operation_status` を参照してください。

   #. | **作業履歴確認** 
      | Ansible-Legacyコンソールの作業管理の画面では、実行した作業の一覧が表示され履歴が確認できます。
      | 詳細は :ref:`ansible_legacy_execution_list` を参照してください。


Ansible driver機能・操作方法説明
================================

.. include:: ../../include/ansible_option_legend-of-registration-screen-item-list.rst

基本コンソール
--------------

| 本節では、ITA基本コンソールでの操作について記載します。
| 本作業は :doc:`../it_automation_base/basic_console` を参照して、ITA基本コンソール画面内で作業を実施してください。


.. _ansible_legacy_input_operation_list:

オペレーション一覧
~~~~~~~~~~~~~~~~~~

| :menuselection:`基本コンソール-->オペレーション一覧` では、オーケストレータで実行する作業対象ホストに対するオペレーションを管理します。作業はITA基本コンソール内メニューより選択します。
| 登録方法の詳細は、関連マニュアルの :doc:`../it_automation_base/basic_console` を参照してください。

.. figure:: /images/ja/basic_console/operation_list/register.png
   :width: 800px
   :alt: サブメニュー画面（オペレーション一覧）

   サブメニュー画面（オペレーション一覧）


Ansible共通コンソール
---------------------

| 本節では、Ansible共通コンソールでの操作について記載します。


.. _ansible_legacy_device_list:

機器一覧
~~~~~~~~
#. | :menuselection:`Ansible共通-->機器一覧` では、作業対象ホストの情報のメンテナンス(閲覧/登録/更新/廃止)を行います。

   .. figure:: /images/ja/ansible_common/devaicelist/device_list.png
      :width: 800px
      :alt: サブメニュー画面（機器一覧）

      サブメニュー画面（機器一覧）

#. | :guilabel:`＋ 登録` ボタンより、機器情報の登録を行います。

   .. figure:: /images/ja/ansible_common/devaicelist/registration_device_list.gif
      :width: 800px
      :alt: 登録画面（機器一覧）

      登録画面（機器一覧）


#. | 登録画面の共通項目一覧は以下のとおりです。

   | Ansible driverを利用する場合には、Ansible利用情報を入力してください。
   | 未入力で作業実行した場合、想定外エラーとなる場合があります。

   .. table:: 登録画面項目一覧（機器一覧）
      :widths: 8 8 8 8 18 12 12 12
      :align: left

      +-----------------------------------+-------------------------------------------------+-----------+--------------+-----------------+
      | 項目                              | 説明                                            | 入力必須  | 入力方法     | 制約事項        |
      |                                   |                                                 |           |              |                 |
      +===================================+=================================================+===========+==============+=================+
      | 管理システム項番                  | 登録情報を識別する一意のIDが自動入力されます。  | ー        | 手動入力     | ー              |   
      +-----------------------------------+-------------------------------------------------+-----------+--------------+-----------------+
      | HW機器種別                        | HW機器の種別を選択します。                      | ー        | リスト選択   | ー              |   
      |                                   |                                                 |           |              |                 |     
      |                                   | ・NW(ネットワーク)                              |           |              |                 |     
      |                                   |                                                 |           |              |                 |     
      |                                   | ・ST(ストレージ)                                |           |              |                 |     
      |                                   |                                                 |           |              |                 |     
      |                                   | ・SV(サーバー)                                  |           |              |                 |     
      |                                   |                                                 |           |              |                 |     
      +-----------------------------------+-------------------------------------------------+-----------+--------------+-----------------+
      | ホスト名                          | ホスト名を記入します。                          | ○         | 手動入力     | 最大長255バイト |   
      +-----------------------------------+-------------------------------------------------+-----------+--------------+-----------------+
      | DNSホスト名                       | ＤＮＳサーバーを使用してホスト名が解決できる\   |           | 手動入力     | 最大長255バイト |   
      |                                   | 名称を入力します。                              |           |              |                 |     
      +-----------------------------------+-------------------------------------------------+-----------+--------------+-----------------+
      | IPアドレス                        | IPアドレス(xxx.xxx.xxx.xxx形式)を記入します。   |           | 手動入力     | 最大長15バイト  |               
      +-----------------+-----------------+-------------------------------------------------+-----------+--------------+-----------------+
      | ログイン\       | ユーザ          | ログインユーザを記入します。                    |           | 手動入力     | 最大長255バイト |   
      | パスワード      |                 |                                                 |           |              |                 |         
      |                 +-----------------+-------------------------------------------------+-----------+--------------+-----------------+
      |                 | パスワード      | パスワードを指定します。                        |           | 手動入力     | 最大長255バイト |        
      +-----------------+-----------------+-------------------------------------------------+-----------+--------------+-----------------+
      | ssh\            | ssh秘密鍵\      | ssh秘密鍵ファイルを指定して鍵認証する場合の\    | ー        | ファイル選択 | 最大サイズ\     |   
      | 鍵認証\         | ファイル        | 秘密鍵ファイルを入力します。アップロード\       |           |              | 100Mバイト      |   
      | 情報            |                 | したファイルは暗号化されて保存されます。        |           |              |                 |   
      |                 |                 |                                                 |           |              |                 |   
      |                 |                 | ※登録後はダウンロード不可となります。           |           |              |                 |       
      |                 +-----------------+-------------------------------------------------+-----------+--------------+-----------------+
      |                 | パスフレーズ    | ssh秘密鍵ファイルにパスフレーズが設定され\      | ー        | 手動入力     | 最大長255バイト |   
      |                 |                 | ている場合、パスフレーズを入力します。          |           |              |                 |        
      +--------+--------+-----------------+-------------------------------------------------+-----------+--------------+-----------------+
      | Ansib\ | Legacy\| 認証方式        | Ansible・Ansible Automation Controller から\    |           | リスト選択   | 説明欄記載\     |   
      | le利用\| /Role\ |                 | 機器へ接続する際の認証方式を選択します。        |           |              | のとおり        |   
      | 情報   | 利用\  |                 |                                                 |           |              |                 |   
      |        | 情報   |                 | ●パスワード認証                                 |           |              |                 |     
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ログインパスワードの管理で●の選択と、\          |           |              |                 |   
      |        |        |                 | ログインパスワードの入力が必須です。            |           |              |                 |     
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ●鍵認証（パスフレーズなし）                     |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ssh秘密鍵ファイル(id_ras\                       |           |              |                 |   
      |        |        |                 | )のアップロードが必須です。                     |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ●鍵認証（パスフレーズあり）                     |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ssh秘密鍵ファイル(id_ras)のアップロードと、\    |           |              |                 |   
      |        |        |                 | パスフレーズの入力が必須です。                  |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ●鍵認証（鍵交換済み）※1                         |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ssh秘密鍵ファイル(id_ras)の\                    |           |              |                 |   
      |        |        |                 | アップロードは必要ありません。                  |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ●パスワード認証（winrm)                         |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | 必要に応じてWinRM接続情報を入力します。         |           |              |                 |     
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | 尚、パスワード認証（winrm)以外の認証方式の\     |           |              |                 |   
      |        |        |                 | 場合、機器側に以下の設定が必要です。            |           |              |                 |      
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ログインユーザの sudo権限を NOPASSWD付で \      |           |              |                 |   
      |        |        |                 | :file:`/etc/sudoers` に設定します。             |           |              |                 |      
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | Exp)                                            |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |
      |        |        |                 | .. code-block::                                 |           |              |                 |
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 |    Demo_user ALL=(ALL) NOPASSWD:ALL             |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        +--------+--------+-------------------------------------------------+-----------+--------------+-----------------+
      |        |        | WinRM\ | ポート\| WindowsServerにWinRM接続する際\                 | ー        | 手動入力     | 説明欄記載\     |   
      |        |        | 接続\  | 番号   | のポート番号を入力します。                      |           |              | のとおり        |   
      |        |        | 情報   |        |                                                 |           |              |                 |   
      |        |        |        |        | 未入力の場合はデフォルト(5985)での\             |           |              |                 |    
      |        |        |        |        | WinRM接続となります。                           |           |              |                 |     
      |        |        |        +--------+-------------------------------------------------+-----------+--------------+-----------------+
      |        |        |        | サーバ\| WinRM接続ポートでhttpsのポート番号を指定した\   | ー        | ファイル選択 | 最大サイズ\     |   
      |        |        |        | 証明書 | 場合にサーバﾞ証明書を入力します。               |           |              | 100Mバイト      |   
      |        |        |        |        |                                                 |           |              |                 |    
      |        |        |        |        | アップロードしたファイルは暗号化されて保存\     |           |              |                 |   
      |        |        |        |        | されます。                                      |           |              |                 |
      |        |        |        |        |                                                 |           |              |                 |
      |        |        |        |        | ※登録後はダウンロード不可となります。           |           |              |                 |    
      |        |        |        |        |                                                 |           |              |                 |   
      |        |        |        |        | サーバ証明書の認証を省く場合、インベントリ\     |           |              |                 |   
      |        |        |        |        | ファイル追加オプションに下記を追記してください。|           |              |                 |      
      |        |        |        |        |                                                 |           |              |                 | 
      |        |        |        |        | .. code-block:: yaml                            |           |              |                 |
      |        |        |        |        |                                                 |           |              |                 |  
      |        |        |        |        |    ansible_winrm_server_cert_validation: ignore |           |              |                 |   
      |        |        |        |        |                                                 |           |              |                 |    
      |        +--------+--------+--------+-------------------------------------------------+-----------+--------------+-----------------+
      |        | 接続オプション           | （ssh接続の場合）                               | ー        | 手動入力     | 最大長4000バイト|   
      |        |                          |                                                 |           |              |                 |   
      |        |                          | :file:`/etc/ansible.cfg/ssh_args` に設定して\   |           |              |                 |   
      |        |                          | いるsshオプション以外のオプションを設定\        |           |              |                 |     
      |        |                          | したい場合、設定したいオプションを入力します。  |           |              |                 |     
      |        |                          |                                                 |           |              |                 |   
      |        |                          | （telnet接続の場合）                            |           |              |                 |   
      |        |                          |                                                 |           |              |                 |     
      |        |                          | telnet接続時のオプションを設定したい場合、\     |           |              |                 |   
      |        |                          | 設定したいオプションを入力します。              |           |              |                 |     
      |        +--------------------------+-------------------------------------------------+-----------+--------------+-----------------+
      |        | インベントリファイル\    | ITAが設定していないインベントリファイルの\      | ー        | 手動入力     | 最大長4000バイト|   
      |        | 追加オプション           | オプションパラメータをyaml形式で入力します。    |           |              |                 |  
      |        |                          |                                                 |           |              |                 |   
      |        |                          | Exp)                                            |           |              |                 |   
      |        |                          |                                                 |           |              |                 |
      |        |                          | .. code-block:: yaml                            |           |              |                 |
      |        |                          |                                                 |           |              |                 |   
      |        |                          |    ansible_connection: network_cli              |           |              |                 |   
      |        |                          |    ansible_network_os: ios                      |           |              |                 |   
      |        |                          |    ansible_become: yes                          |           |              |                 |   
      |        |                          |    ansible_become_method: enable                |           |              |                 |   
      |        |                          |                                                 |           |              |                 |      
      |        |                          | 各パラメータ値を変数で記述することも出来ます。  |           |              |                 |   
      |        |                          |                                                 |           |              |                 | 
      |        |                          | .. code-block:: yaml                            |           |              |                 |
      |        |                          |                                                 |           |              |                 |  
      |        |                          |    ansible_become_password: '{{ VAR_passwd }}'  |           |              |                 |   
      |        |                          |                                                 |           |              |                 |     
      |        |                          | 具体値に変数を記述する場合                      |           |              |                 |   
      |        |                          |                                                 |           |              |                 |   
      |        |                          | '{{ VAR_passwd }}'                              |           |              |                 |   
      |        |                          |                                                 |           |              |                 |          
      |        |                          | ':シングル・ダブルコーテーションで囲む「必須」  |           |              |                 |     
      |        |                          |                                                 |           |              |                 |   
      |        |                          | 変数の具体値は「 :ref:`ansible_legacy\          |           |              |                 |   
      |        |                          | _substitution_value_auto_registration\          |           |              |                 | 
      |        |                          | _setting` 」や「 :ref:`ansible_legacy\          |           |              |                 |  
      |        |                          | _substitution_value_list` 」\                   |           |              |                 |   
      |        |                          | メニューから登録します。                        |           |              |                 |     
      |        +--------+-----------------+-------------------------------------------------+-----------+--------------+-----------------+
      |        | Ansi\  | インスタンス\   | Ansible Automation Controller がクラスタ構成の\ | ー        | リスト選択   | ー              |   
      |        | ble \  | グループ名※2    | 場合、どのインスタンスグループで実行するかを選\ |           |              |                 |   
      |        | Autom\ |                 | 択します。ここで設定した、インスタンスグループ\ |           |              |                 |   
      |        | ation \|                 | はインベントリオブジェクトに設定されます。      |           |              |                 |   
      |        | Contr\ |                 |                                                 |           |              |                 |   
      |        | oller \|                 | 未選択の場合はAnsible Automation Controller の\ |           |              |                 |   
      |        | 利用\  |                 | デフォルトのインスタンスグループになります。    |           |              |                 |   
      |        | 情報   |                 |                                                 |           |              |                 |   
      |        |        |                 | Ansible Automation Controller がクラスタ構成\   |           |              |                 |   
      |        |        |                 | でない場合は、未選択で構いません。              |           |              |                 |     
      |        |        +-----------------+-------------------------------------------------+-----------+--------------+-----------------+
      |        |        | 接続タイプ      | Ansible Automation Controller認証情報の接続\    | ○         | リスト選択   |                 |   
      |        |        |                 | タイプを設定します。通常はmachineを選択します。\|           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | ansible_connectionをlocalに設定する必要がある\  |           |              |                 |   
      |        |        |                 | Network OSの場合にNetworkを選択します。         |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | Networkを選択した場合、インベントリファイル追加\|           |              |                 |   
      |        |        |                 | オプションにPlatform Options(ansible_connection\|           |              |                 |   
      |        |        |                 | 以外)を設定する必要があります。                 |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | Exp)                                            |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | インベントリファイル追加オプションの設定例      |           |              |                 |      
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | Network OSがiosの場合の設定値                   |           |              |                 |      
      |        |        |                 |                                                 |           |              |                 | 
      |        |        |                 | .. code-block:: yaml                            |           |              |                 |
      |        |        |                 |                                                 |           |              |                 |  
      |        |        |                 |    ansible_network_os: ios                      |           |              |                 |   
      |        |        |                 |    ansible_become: yes                          |           |              |                 |   
      |        |        |                 |    ansible_become_method: enable                |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |     
      |        |        |                 | Ansible Automation Controllerの認証情報の接続\  |           |              |                 |   
      |        |        |                 | タイプについては、ドキュメント `認証情報タイ    |           |              |                 |   
      |        |        |                 | プ <https://docs.ansible.com/ansible-tower/3.   |           |              |                 |    
      |        |        |                 | 6.4/html_ja/userguide/credentials.html>`__ \    |           |              |                 |      
      |        |        |                 | を参照してください。                            |           |              |                 |   
      |        |        |                 |                                                 |           |              |                 |   
      |        |        |                 | Network OSとansible_connectionの関連やPlat\     |           |              |                 |      
      |        |        |                 | form Optionsについては、Ansibleドキュメント \   |           |              |                 |   
      |        |        |                 | `Platform Options <https://docs.ansible.com/    |           |              |                 |     
      |        |        |                 | ansible/devel/network/user_guide/platform_inde  |           |              |                 |     
      |        |        |                 | x.html>`__ \ を参照してください。               |           |              |                 |      
      +--------+--------+-----------------+-------------------------------------------------+-----------+--------------+-----------------+
      | 備考                              | 自由記述欄です。                                | ー        | 手動入力     | 最大長4000バイト|     
      +-----------------------------------+-------------------------------------------------+-----------+--------------+-----------------+

   
 
   .. note:: | ※1 認証方式が鍵認証（鍵交換済み）に設定する為に必要な公開鍵ファイルの配布
   
      - | Ansible Coreの場合
        | ansibleがインストールされているサーバーの実行ユーザー「Ansible共通コンソール=>インターフェース情報に設定されている実行ユーザー」から作業対象ホストにssh接続します。
        | 実行ユーザーの公開鍵ファイルをログイン先ユーザーのauthorized_keysにコピーしてください。
   
      - | Ansible Automation Controllerの場合
        | Ansible Automation Controllerのawxユーザーから作業対象ホストにssh接続しています。
        | awxユーザーの公開鍵ファイルをログイン先ユーザーのauthorized_keysにコピーしてください。ブラウザよりAnsible Automation Controllerにログインし、「設定」→「ジョブ」→「分離されたジョブに公開するパス」に :file:`/var/lib/awx/.ssh/` を設定します。
      
        .. image:: /images/ja/diagram/ansible_automationcontroller.png
           :width: 4.97986in
           :height: 1.51304in
           :align: center
         
        | 尚、AnsibleTower4.x以降、awxユーザーの.sshディレクトリが扱えない為、作業対象ホストと鍵認証（鍵交換済み）での接続は出来ません。

   .. note:: | ※2 Ansible driverのバックヤード機能 「Ansible Automation Controllerデータ同期」により取得したデータから選択します。



.. _ansible_legacy_interface_information:

インターフェース情報
~~~~~~~~~~~~~~~~~~~~

#. | :menuselection:`Ansible共通-->インターフェース情報` では、Ansible Core、AnsibleTower、Ansible Automation Controllerのいずれかを実行エンジンに選択し、ITAシステム・Ansible driverサーバと実行エンジンのサーバが共有するディレクトリのパスのおよび実行エンジンのサーバへの接続インターフェース情報のメンテナンス(閲覧/更新)を行います。

   .. figure:: /images/ja/ansible_common/Interface_information/interface_information.png
      :width: 800px
      :alt: サブメニュー画面（インタフェース情報）

      サブメニュー画面（インタフェース情報）

#. | :guilabel:`編集` ボタンより、インターフェース情報の登録を行います。

   .. figure:: /images/ja/ansible_common/Interface_information/registration_interface_information.gif
      :width: 800px
      :alt: 登録画面（インタフェース情報）

      登録画面（インタフェース情報）

#. | インタフェース情報画面の項目一覧は以下のとおりです。
   | インタフェース情報が未登録または、複数レコード登録されている状態で作業実行した場合、作業実行は想定外エラーとなります。

   .. table:: 登録画面項目一覧（インタフェース情報）
      :widths: 8 8 8 24 8 8 10
      :align: left

      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | 項目                              | 説明                         | 入力必須  | 入力方法     | 制約事項        |
      |                                   |                              |           |              |                 |
      +=================+========+========+==============================+===========+==============+=================+
      | 実行エンジン                      | 実行するエンジンを\          | ○         | リスト選択   |                 |
      |                                   | 下記の2種類から選択します。  |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | ・Ansible Core               |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | ・Ansible Automation \       |           |              |                 |
      |                                   | Controller                   |           |              |                 |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | Ansible \       | 代表ホスト      | Ansible Automation \         | ー        | リスト選択   | 実行エンジ\     |
      | Automation \    |                 | Controllerホスト一覧に\      |           |              | ンがAnsible \   |
      | Controller \    |                 | 登録されているホストの一覧\  |           |              | Cor\            |
      | インターフェース|                 | より、ITAと通信するAnsible \ |           |              | e以外の場合\    |
      |                 |                 | Automation \                 |           |              | に入力必須      |
      |                 |                 | Controllerを選択します。     |           |              |                 |
      |                 |                 |                              |           |              |                 |
      |                 +--------+--------+------------------------------+-----------+--------------+-----------------+
      |                 | プロトコル      | Ansible Automation \         | ー        | 手動入力     | 実行エンジ\     |
      |                 |                 | Contr\                       |           |              | ンがAnsible \   |
      |                 |                 | ollerサーバとのプロトコルを \|           |              | Cor\            |
      |                 |                 | http / \                     |           |              | e以外の場合\    |
      |                 |                 | https \                      |           |              | に入力必須      |
      |                 |                 | のどちらかを入力します。     |           |              |                 |
      |                 |                 |                              |           |              |                 |
      |                 +--------+--------+------------------------------+-----------+--------------+-----------------+
      |                 | ポート          | Ansible Automation \         | ー        | 手動入力     | 実行エンジ\     |
      |                 |                 | Controllerサーバの接\        |           |              | ンがAnsible \   |
      |                 |                 | 続ポート(80/443)を入力しま\  |           |              | Cor\            |
      |                 |                 | す。通常はHTTPS(443)です。   |           |              | e以外の場合\    |
      |                 |                 |                              |           |              | に入力必須      |
      |                 +--------+--------+------------------------------+-----------+--------------+-----------------+
      |                 | 組織名          | Ansible Automation \         | ー        | リスト選択   |                 |
      |                 |                 | Controllerサーバに登録され\  |           |              |                 |
      |                 |                 | ている組織名を選択します。   |           |              |                 |
      |                 |                 |                              |           |              |                 |
      |                 +--------+--------+------------------------------+-----------+--------------+-----------------+
      |                 | 認証トークン    | ITAからAnsible Automation \  | ー        | 手動入力     | 最大\           |
      |                 |                 | Controlle\                   |           |              | 長255バイト     |
      |                 |                 | rサーバに接続するユーザーの\ |           |              |                 |
      |                 |                 | 認証トークンを入力します。   |           |              | 実行エンジ\     |
      |                 |                 |                              |           |              | ンがAnsible \   |
      |                 |                 |                              |           |              | Cor\            |
      |                 |                 |                              |           |              | e以外の場合\    |
      |                 |                 |                              |           |              | に入力必須      |
      |                 +--------+--------+------------------------------+-----------+--------------+-----------------+
      |                 | 実行時データ削除| 作業実行時にITAとAnsible \   | ー        | リスト選択   | 実行エンジ\     |
      |                 |                 | Automation Controller \      |           |              | ンがAnsible \   |
      |                 |                 | 内に一時的に生成した\        |           |              | Cor\            |
      |                 |                 | データリソースを作業終了後\  |           |              | e以外の場合\    |
      |                 |                 | に削除するかを選択します。   |           |              | に入力必須      |
      |                 |                 | 「削\                        |           |              |                 |
      |                 |                 | 除する」を選択した場合に削\  |           |              |                 |
      |                 |                 | 除されるデータリソースは「 \ |           |              |                 |
      |                 |                 | :ref:`ansible_legacy\        |           |              |                 |
      |                 |                 | _data_resources_deleted\     |           |              |                 |
      |                 |                 | _when_executing` \           |           |              |                 |
      |                 |                 | 」を参照してください。       |           |              |                 |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | Proxy           | Address         | プロキシサー\                | ー        | 手動入力     | 最\             |
      |                 |                 | バのアドレスを入力します。   |           |              | 大255バイト     |
      |                 |                 |                              |           |              |                 |
      |                 |                 | ITAがプロキシ\               |           |              |                 |
      |                 |                 | 環境下にある場合、Ansible/\  |           |              |                 |
      |                 |                 | Ansible Automation \         |           |              |                 |
      |                 |                 | Controlle\                   |           |              |                 |
      |                 |                 | rサーバまでの疎通のために設\ |           |              |                 |
      |                 |                 | 定が必要な場合があります。   |           |              |                 |
      |                 |                 |                              |           |              |                 |
      |                 |                 | プロキシサーバのURLが\       |           |              |                 |
      |                 |                 |                              |           |              |                 |
      |                 |                 | \http://\                    |           |              |                 |
      |                 |                 | procy.gate.co.jp:8080の場合\ |           |              |                 |
      |                 |                 |                              |           |              |                 |
      |                 |                 | Address\                     |           |              |                 |
      |                 |                 | にはhttp://procy.gate.co.jp\ |           |              |                 |
      |                 |                 | を入力します。               |           |              |                 |
      |                 |                 |                              |           |              |                 |
      |                 |                 | Portには 8080を入力します。  |           |              |                 |
      |                 +--------+--------+------------------------------+-----------+--------------+-----------------+
      |                 | Port            | プロキシサ\                  | ー        | 手動入力     |                 |
      |                 |                 | ーバのポートを入力します。   |           |              |                 |
      |                 |                 |                              |           |              |                 |
      |                 |                 | ITAがプロキシ\               |           |              |                 |
      |                 |                 | 環境下にある場合、Ansible/\  |           |              |                 |
      |                 |                 | Ansible Automation \         |           |              |                 |
      |                 |                 | Controlle\                   |           |              |                 |
      |                 |                 | rサーバまでの疎通のために設\ |           |              |                 |
      |                 |                 | 定が必要な場合があります。   |           |              |                 |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | Ansible-vaultパスワード           | ansible-vaultコマンドで変数\ | ー        | 手動入力     | 最大\           |
      |                                   | の具体値を暗号化する場合の\  |           |              | 長64バイト      |
      |                                   | パスワードを入力します。     |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | 空白の場合は、デフォルト値\  |           |              |                 |
      |                                   | が使用します。               |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   |                              |           |              |                 |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | オプションパラメータ              | Movement共通のオプショ\      | ー        | 手動入力     | 最大\           |
      |                                   | ンパラメータを入力します。   |           |              | 長4000バイト    |
      |                                   |                              |           |              |                 |
      |                                   | 実行エンジンがAnsible \      |           |              |                 |
      |                                   | Coreの場合はansible-playboo\ |           |              |                 |
      |                                   | kコマンドのオプションパラメ\ |           |              |                 |
      |                                   | ータ、実行エンジンが\        |           |              |                 |
      |                                   | Ansible Core以外\            |           |              |                 |
      |                                   | の場合はジョブテンプレート\  |           |              |                 |
      |                                   | のパラメータを入力します。   |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | Movement固\                  |           |              |                 |
      |                                   | 有のオプションパラメータは\  |           |              |                 |
      |                                   | Movement一覧で入力します。   |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | オプションパ\                |           |              |                 |
      |                                   | ラメータの詳細については、\  |           |              |                 |
      |                                   | 「 :ref:`ansible_legacy\     |           |              |                 |
      |                                   | _option_parameter_list` 」\  |           |              |                 |
      |                                   | を参照してください。         |           |              |                 |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | NULL連携                          | 代入値自動登録\              | ○         | リスト選択   | ー              |
      |                                   | 設定でパラメータシートの具\  |           |              |                 |
      |                                   | 体値がNULL(空白)の場合に、\  |           |              |                 |
      |                                   | 代入値管理への登録をNULL(空\ |           |              |                 |
      |                                   | 白)の値で行うか設定します。  |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | 代入値自動登録設定メニ\      |           |              |                 |
      |                                   | ューの「NULL連携」が空白の\  |           |              |                 |
      |                                   | 場合この値が適用されます。   |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | ・「有効」\                  |           |              |                 |
      |                                   | の場合、パラメータシートの\  |           |              |                 |
      |                                   | 値がどのような値でも代入値\  |           |              |                 |
      |                                   | 管理への登録が行われます。   |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | ・「無効」の\                |           |              |                 |
      |                                   | 場合、パラメータシートに値\  |           |              |                 |
      |                                   | が入っている場合のみ代入値\  |           |              |                 |
      |                                   | 管理への登録が行われます。   |           |              |                 |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | 状態監視周期(単位ミリ秒)          | 「:ref:`ansible_legacy_c\    | ○         | 手動入力     | 最小値1000\     |
      |                                   | heck_operation_status`」で\  |           |              | ミリ秒          |
      |                                   | 表示されるログのリフレッシ\  |           |              |                 |
      |                                   | ュ間隔を入力します。通常は3\ |           |              |                 |
      |                                   | 000ミリ秒程度が推奨値です。  |           |              |                 |
      |                                   |                              |           |              |                 |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | 進行状態表示行数                  | 「:ref:`ansible_legacy_c\    | ○         | 手動入力     | ー              |
      |                                   | heck_operation_status`」\    |           |              |                 |
      |                                   | での進行ログ・エラーログの\  |           |              |                 |
      |                                   | 最大表示行数を入力します。   |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | ステータスが[未実\           |           |              |                 |
      |                                   | 行]、[準備中]、[実行中]、[\  |           |              |                 |
      |                                   | 実行中(遅延)]の場合、指定し\ |           |              |                 |
      |                                   | た行数でログを出力します。   |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | ステータス\                  |           |              |                 |
      |                                   | が[完了]、[完了(異常)]、[想\ |           |              |                 |
      |                                   | 定外エラー]、[緊急停止]、[\  |           |              |                 |
      |                                   | 未実行(予約)]、[予約取消]の\ |           |              |                 |
      |                                   | 場合、指定した行数ではなく\  |           |              |                 |
      |                                   | すべてのログを出力します。   |           |              |                 |
      |                                   |                              |           |              |                 |
      |                                   | 環境毎にチュ\                |           |              |                 |
      |                                   | ーニングを要しますが、通常\  |           |              |                 |
      |                                   | は1000行程度が推奨値です。   |           |              |                 |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+
      | 備考                              | 自由記述欄です。             | ー        | 手動入力     | 最大長\         |
      |                                   |                              |           |              | 4000バイト      |
      +-----------------+--------+--------+------------------------------+-----------+--------------+-----------------+


.. _ansible_legacy_ansible_automation_controlller_hosts:

Ansible Automation Controller ホスト一覧
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. include:: ../../include/ansible_option_ansible_automation_controlller_hosts.rst


.. _ansible_legacy_global_variable_list:

グローバル変数管理
~~~~~~~~~~~~~~~~~~


.. include:: ../../include/ansible_option_global_variable_list.rst


.. _ansible_legacy_file_list:

ファイル管理
~~~~~~~~~~~~

.. include:: ../../include/ansible_option_file_list.rst


.. _ansible_legacy_template_list:

テンプレート管理
~~~~~~~~~~~~~~~~

.. include:: ../../include/ansible_option_template_list1.rst

.. warning:: | **テンプレートの変数定義を読み取るタイミング**
   | 内部の処理でテンプレートの変数定義を読み取り、「 :ref:`ansible_legacy_substitution_value_auto_registration_setting` 」で具体値が登録可能になります。
   | 読み取りのタイミングはリアルタイムではないので、「 :ref:`ansible_legacy_substitution_value_auto_registration_setting` 」で変数が扱えるまでに時間がかかる場合があります。

.. include:: ../../include/ansible_option_template_list2.rst


.. _ansible_legacy_unmanaged_var_list:

管理対象外変数リスト
~~~~~~~~~~~~~~~~~~~~        

.. include:: ../../include/ansible_option_unmanaged_var_list.rst


Ansible-Legacyコンソール
------------------------------

| Ansible-LegacyRoleコンソールの操作です。

.. _ansible_legacy_movement_list:

Movement一覧
~~~~~~~~~~~~

#. | :menuselection:`Ansible-LegacyRole-->Movement一覧` ではMovement名のメンテナンス(閲覧/登録/更新/廃止)を行います。

   .. figure:: /images/ja/ansible-legacyrole/movement_list/movement_list.png
      :width: 800px
      :alt: サブメニュー画面（Movement一覧）

      サブメニュー画面（Movement一覧）

#. | :guilabel:`＋ 登録` ボタンより、Movement情報の登録を行います。

   .. figure:: /images/ja/ansible-legacyrole/movement_list/registration_movement_list.gif
      :width: 800px
      :alt: 登録画面（Movement一覧）

      登録画面（Movement一覧）


#. | 登録画面の項目一覧は以下のとおりです。

   .. table:: 登録画面項目一覧（Movement一覧）
      :align: left

      +-----------------------------------+-------------------------------------------------+-----------+--------------+-------------------+
      | 項目                              | 説明                                            | 入力必須  | 入力方法     | 制約事項          |
      |                                   |                                                 |           |              |                   |
      |                                   |                                                 |           |              |                   |
      +===================================+=================================================+===========+==============+===================+
      | Movement名                        | Movementの名称を入力します。                    | ○         | 手動入力     | 最大長255バイト   |
      +-----------------------------------+-------------------------------------------------+-----------+--------------+-------------------+
      | 遅延タイマー                      | Movementが指定期間遅延した場合にステータスを\   | ー        | 手動入力     | ー                |
      |                                   | 遅延として警告表示したい場合に指定期間(1～)を\  |           |              |                   |
      |                                   | 入力します。(単位:分)                           |           |              |                   |
      |                                   |                                                 |           |              |                   |
      |                                   | 未入力の場合は警告表示しません。                |           |              |                   |
      +-----------------+-----------------+-------------------------------------------------+-----------+--------------+-------------------+
      | Ansible利用情報 | ホスト指定形式  | 特別にIPアドレスで表現しないホストを指定したい\ | ○         | リスト選択   | ー                |
      |                 |                 | 場合に「ホスト名」を選択します。                |           |              |                   |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 | 通常はIPが推奨です。                            |           |              |                   |
      |                 +-----------------+-------------------------------------------------+-----------+--------------+-------------------+
      |                 | WinRM接続       | 対象ホストがWindowsServerの場合に、\            | ー        | リスト選択   | ー                |
      |                 |                 | 「●」を選択します。                             |           |              |                   |
      |                 +-----------------+-------------------------------------------------+-----------+--------------+-------------------+
      |                 | ヘッダー\       | ITAが自動生成する親Playbookの先頭からtasksまた\ | ー        | 手動入力     | 最大長4000バイト  |
      |                 | セクション      | はrolesセクションまでのセクションを編集します。 |           |              |                   |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 | 未入力の場合は、以下を適用します。              |           |              |                   |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 | .. code-block:: yaml                            |           |              |                   |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 |    # Ansible                                    |           |              |                   |
      |                 |                 |    - hosts: all                                 |           |              |                   |
      |                 |                 |      remote_user: "{{ __loginuser__ }}"         |           |              |                   |
      |                 |                 |      gather_facts: no                           |           |              |                   |
      |                 |                 |      become: yes                                |           |              |                   |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 |    # Ansible Automation Controller              |           |              |                   |
      |                 |                 |    - hosts: all                                 |           |              |                   |
      |                 |                 |      gather_facts: no                           |           |              |                   |
      |                 |                 |      become: yes                                |           |              |                   |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 | ※winrm接続の場合は become: yesは適用しません。  |           |              |                   |
      |                 +-----------------+-------------------------------------------------+-----------+--------------+-------------------+
      |                 | オプション\     | Movement固有のオプションパラメータを入力します。| ー        | 手動入力     | 最大長4000バイト  |
      |                 | パラメータ      |                                                 |           |              |                   |
      |                 |                 | 実行エンジンがAnsible Coreの場合はansible-play\ |           |              |                   |
      |                 |                 | bookコマンドのオプションパラメータ、実行エンジ  |           |              |                   |
      |                 |                 | ンがAnsible Core以外の場合はジョブテンプレート\ |           |              |                   |
      |                 |                 | のパラメータを入力します。                      |           |              |                   |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 | オプションパラメータの詳細については、「 \      |           |              |                   |
      |                 |                 | :ref:`ansible_legacy_option\                    |           |              |                   |
      |                 |                 | _parameter_list` 」を参照してください。         |           |              |                   |
      |                 +-----------------+-------------------------------------------------+-----------+--------------+-------------------+
      |                 | ansible.cfg     | 作業実行時に使用するansible.cfgを\              | ー        | ファイル選択 | 最大サイズ100M\   |
      |                 |                 | アップロードします。                            |           |              | バイト            |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 | 未アップロードの場合は、デフォルトが使用され\   |           |              |                   |
      |                 |                 | ます。                                          |           |              |                   |
      |                 |                 |                                                 |           |              |                   |
      |                 |                 | また、ロールパッケージ管理でアップロードされて\ |           |              |                   |
      |                 |                 | いるzipファイルにansible.cfgが含まれている場合\ |           |              |                   |
      |                 |                 | は、この項目でアップロードしたansible.cfgで\    |           |              |                   |
      |                 |                 | 上書きされます。                                |           |              |                   |
      |                 +--------+--------+-------------------------------------------------+-----------+--------------+-------------------+
      |                 | Ansibl\| 実行\  | Ansible Automation Controllerサーバに構築され\  | ー        | リスト選択   |                   |
      |                 | e Auto\| 環境   | ている実行環境が表示されています。              |           |              |                   |
      |                 | matio\ |        |                                                 |           |              |                   |
      |                 | n Cont\|        | 実行する実行環境を選択します。                  |           |              |                   |
      |                 | roller\|        |                                                 |           |              |                   |
      |                 | 利用\  |        | 未選択の場合は、デフォルト「Default execution \ |           |              |                   |
      |                 | 情報   |        | environment」が使用されます。                   |           |              |                   |
      +-----------------+--------+--------+-------------------------------------------------+-----------+--------------+-------------------+
      | 備考                              | 自由記述欄です。                                | ー        | 手動入力     | 最大長4000バイト  |
      +-----------------------------------+-------------------------------------------------+-----------+--------------+-------------------+
   

   .. warning:: 
      | WinRM接続で「〇」を選択した場合は接続するホストをすべてWindowsServerとみなします。

.. _ansible_legacy_playbook_file_list_ansible_legacy_only:

Playbook素材集
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

#. | [Playbook素材集]ではユーザーが作成したPlaybookの登録／更新／廃止を行います。
   | ※本メニューはAnsible-Legacy コンソールにのみ存在します。
   | Playbookの記述など関しては、「 :ref:`ansible_legacy_write_playbook_ansible_legacy` 」を参照してください。
   
   .. figure:: ./general_operations/image28.png
      :width: 6.22721in
      :height: 2.78024in
      :alt: サブメニュー画面（Playbook素材集）
      
      サブメニュー画面（Playbook素材集）

#. | 「登録」-「登録開始」ボタンより、Playbookの登録を行います。
 
   .. figure:: ./general_operations/image29.png
      :width: 5.99563in
      :height: 0.89595in
      :alt: 登録画面（Playbook素材集）
      
      登録画面（Playbook素材集）

#. | Movement-Playbook紐付ボタンをクリックすると、対象の :ref:`ansible_legacy_movement_details` へ遷移します。
 
   .. figure:: ./general_operations/image30.png
      :width: 6.16965in
      :height: 1.25024in
      :alt: サブメニュー画面（Playbook素材集）
      
      サブメニュー画面（Playbook素材集）

#. | 登録画面の項目一覧は以下のとおりです。


   .. list-table:: 登録画面項目一覧（Playbook素材集）
      :widths: 20 50 10 10 10
      :header-rows: 1
      :align: left
       
      * - 項目
        - 説明
        - 入力必須
        - 入力方法
        - 制約事項
      * - プレイブック素材名
        - ITAで管理するプレイブック素材名を入力します。
        - 〇
        - 手動入力
        - 最大長256バイト
      * - プレイブック素材
        - | 作成したPlaybookファイルをアップロードします。
          | アップロードするPlaybookファイルは文字コードがUTF-8のBOMで作成してください。
          | 文字コードがUTH-8のBOMなし以外のPlaybookファイルはアップロードでエラーになります。
        - 〇
        - ファイル選択
        - 最大サイズ4Gバイト
      * - 備考
        - 自由記述欄です。
        - ー
        - 手動入力
        - 最大長4000バイト

   
   | 「登録」の前に、「プレイブック素材」を「事前アップロード（①）」してください。「アップロード状況（②）」にPlaybookのファイル名が表示されたのを確認してから、「登録」ボタンを押してください。
   
   .. image:: ./general_operations/image_2a_3.png
      :width: 1.81218in
      :height: 0.98027in
      :align: center
   
   | 内部の処理でPlaybookファイル内に定義している変数を抜出します。抜出した変数は、「 :ref:`ansible_legacy_substitution_value_list` 」や「:ref:`ansible_legacy_substitution_value_auto_registration_setting` 」で具体値の登録が可能になります。
   | 抜出するタイミングはリアルタイムではありませんので、「 :ref:`ansible_legacy_substitution_value_list` 」や「:ref:`ansible_legacy_substitution_value_auto_registration_setting` 」で変数が扱えるまでに **時間がかかる※** 場合があります。
   | ※ 抜出のタイミングは「 :ref:`ansible_legacy_about_the_maintenance_method` 」に記載していますので、そちらをご参照ください。




.. _ansible_legacy_movement_details:

Movement-Playbook紐付
~~~~~~~~~~~~~~~~~~~~~~~~~~

#. | Movementで実行するロールパッケージのメンテナンス(閲覧/登録/更新/廃止)を行います。

   .. figure:: /images/ja/ansible-legacyrole/movement_role/movement_role.png
      :width: 800px
      :alt: サブメニュー画面（Movement-ロール紐付）

      サブメニュー画面（Movement-ロール紐付）

#. | :guilabel:`＋ 登録` ボタンより、Movement-ロール紐付の登録を行います。

   .. figure:: /images/ja/ansible-legacyrole/movement_role/registration_movement_role.gif
      :width: 800px
      :alt: 登録画面（Movement-ロール紐付）

      登録画面（Movement-ロール紐付）
   

#. | 登録画面の項目一覧は以下のとおりです。

- | **Ansible-Legacy の場合** 

  .. list-table:: 登録画面項目一覧（Movement-Playbook紐付の場合）
     :widths: 10 50 10 10 10
     :header-rows: 1
     :align: left
      
     * - 項目
       - 説明
       - 入力必須
       - 入力方法
       - 制約事項
     * - Movement
       - | Movement一覧で登録したMovementが表示されます。
         | Movementを選択します。
       - 〇
       - リスト選択
       - ー
     * - プレイブック素材
       - | 「:ref:`ansible_legacy_playbook_file_list_ansible_legacy_only`」で登録したプレイブック素材が表示されます。
         | プレイブック素材を選択します。
       - 〇
       - リスト選択
       - ー
     * - インクルード順序
       - | プレイブック素材の実行順序(1～:一意値)を入力します。
         | 入力されたインクルード順序(昇順)でプレイブック素材が実行されます。
       - 〇
       - 手動入力
       - 半角整形
     * - 備考
       - 自由記述欄です。
       - ー
       - 手動入力
       - 最大長4000バイト


.. _ansible_legacy_substitution_value_auto_registration_setting:

代入値自動登録設定
~~~~~~~~~~~~~~~~~~

#. | メニュー作成機能で作成したパラメータシートの項目の設定値とMovementの変数を紐付けます。登録した情報は内部の処理により代入値管理と作業対象ホストに反映されます。

   .. figure:: /images/ja/ansible-legacyrole/substitution_value_automatic_setting/substitution_value_auto_registration_setting_role.png
      :width: 800px
      :alt: サブメニュー画面（代入値自動登録設定）

      サブメニュー画面（代入値自動登録設定）

#. | :guilabel:`＋ 登録` ボタンより代入値自動登録設定を行います。

   .. figure:: /images/ja/ansible-legacyrole/substitution_value_automatic_setting/registration_substitution_value_auto_registration_setting_role.gif
      :width: 800px
      :alt: 登録画面（代入値自動登録設定）

      登録画面（代入値自動登録設定）


#. | 登録画面の項目一覧は以下のとおりです。


   .. table:: 登録画面項目一覧（代入値自動登録設定）
      :align: left

      +-----------------------------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      | 項目                              | 説明                                            | 入力必須                                     | 入力方法     | 制約事項          |
      |                                   |                                                 |                                              |              |                   |
      |                                   |                                                 |                                              |              |                   |
      +=================+=================+=================================================+==============================================+==============+===================+
      | パラメータシー\ | メニューグルー\ | メニュー作成機能で作成したパラメータシートの項\ | ○                                            | リスト選択   | ー                |
      | ト(From)        | プ:メニュー:項目| 目が表示されます。                              |                                              |              |                   |
      |                 |                 |                                                 |                                              |              |                   |
      |                 |                 | 対象の項目を選択します。                        |                                              |              |                   |
      |                 |                 |                                                 |                                              |              |                   |
      |                 +-----------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      |                 | 代入順序        | メニュー作成機能で作成したパラメータシートが\   |  :ref:`※1 <ansible_legacy_parashi_\          | 手動入力     | 1～2147483647     |
      |                 |                 | 縦型メニューの場合、\                           |  substitution>`                              |              |                   |            
      |                 |                 | パラメータシートで登録している代入順序を\       |                                              |              |                   |
      |                 |                 | 入力します。                                    |                                              |              |                   |
      +-----------------+-----------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      | 登録方式                          | Value型:項目の設定値を紐付けた変数の具体値\     | ○                                            | リスト選択   | ー                |
      |                                   | とする場合に選択します。                        |                                              |              |                   |
      |                                   |                                                 |                                              |              |                   |
      |                                   | Key型:項目の名称を紐付けた変数の具体値\         |                                              |              |                   |
      |                                   | とする場合に選択します。                        |                                              |              |                   |
      |                                   |                                                 |                                              |              |                   |
      |                                   | 項目の設定値が空白の場合\                       |                                              |              |                   |
      |                                   | は紐付け対象外となります。                      |                                              |              |                   |
      +-----------------------------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      | Movement名                        | Movement一覧で登録したMovementが表示されます。  | ○                                            | リスト選択   | ー                |
      |                                   |                                                 |                                              |              |                   |
      |                                   | Movementを選択します。                          |                                              |              |                   |
      +-----------------+-----------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      | IaC変数(To)     | Movement名\     | Movement-ロール紐付で登録した資材で使用している\| ○                                            | リスト選択   | ー                |
      |                 | :変数名         | 変数が表示されます。                            |                                              |              |                   |
      |                 |                 |                                                 |                                              |              |                   |
      |                 |                 | 具体値に紐付けたい変数を選択します。            |                                              |              |                   |
      |                 +-----------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      |                 | Movement名:変\  | 変数名で多段変数を選択した場合に多段変数の\     |  :ref:`※2 <ansible_legacy_member>`           | リスト選択   |                   |
      |                 | 数名:メンバー\  | メンバー変数が表示されます。                    |                                              |              |                   |
      |                 | 変数            |                                                 |                                              |              |                   |
      |                 |                 | メンバー変数を選択します。                      |                                              |              |                   |
      |                 +-----------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      |                 | 代入順序        | 複数具体値が設定できる変数の場合のみ必須入力\   |  :ref:`※3 <ansible_legacy_substitution>`     | 手動入力     | 1～2147483647     |
      |                 |                 | になります。                                    |                                              |              |                   |
      |                 |                 |                                                 |                                              |              |                   |
      |                 |                 | 具体値の代入順序（1～）を入力します。入力値に\  |                                              |              |                   |
      |                 |                 | 従い昇順で代入されます。具体値が複数ない場合で\ |                                              |              |                   |
      |                 |                 | も代入順序（1～）を入力します。                 |                                              |              |                   |
      +-----------------+-----------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      | NULL連携                          | パラメータシートの具体値がNULL(空白)の場合に、\ | ※4                                           | リスト選択   | ー                |
      |                                   | 代入値管理への登録をNULL(空白)の値で行うか設定\ |                                              |              |                   |
      |                                   | します。                                        |                                              |              |                   |
      |                                   |                                                 |                                              |              |                   |
      |                                   | ・「True」の場合、パラメータシートの値がどのよ\ |                                              |              |                   |
      |                                   | うな値でも代入値管理への登録が行われます。      |                                              |              |                   |
      |                                   |                                                 |                                              |              |                   |
      |                                   | ・「False」の場合、パラメータシートに値が入っ\  |                                              |              |                   |
      |                                   | ている場合のみ代入値管理への登録が行われます。  |                                              |              |                   |
      |                                   |                                                 |                                              |              |                   |
      |                                   | ・空白の場合、Ansibleインターフェース情報の\    |                                              |              |                   |
      |                                   | 「NULL連携」の値が適用されます。                |                                              |              |                   |
      +-----------------------------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
      | 備考                              | 自由記述欄です。                                | ー                                           | 手動入力     | 最大長4000バイト  |
      +-----------------------------------+-------------------------------------------------+----------------------------------------------+--------------+-------------------+
   
   | ※1:パラメータシート(縦メニュー)を使用する場合のみ必須
   | ※2:選択した変数が多段変数の場合のみ必須
   | ※3:選択した変数が複数具体値設定可能な変数の場合のみ必須
   | ※4:任意

.. _ansible_legacy_parashi_substitution:

.. note:: | **パラメータシート(縦メニュー)の場合**
   | パラメータシート(縦メニュー)のリピート設定されている項目とMovementの変数を紐付ける場合、 :menuselection:`Ansible-Legacy-->代入値自動登録設定` でパラメータシート(From) の代入順序を入力する必要があります。
   | パラメータシート(縦メニュー)と代入値自動登録設定の関係を以下の図に示します。

   .. figure:: /images/ja/diagram/parameter.png
      :width: 600px
      :alt: パラメータシート(縦メニュー)使用時の代入値自動登録設定登録方法

..
  .. _ansible_legacy_member:
  
  .. note:: | **メンバー変数の選択**
     
     | 多段変数の場合にのみメンバー変数の選択が必要になります。メンバー変数に表示される変数は具体値を必要とする変数のみです。
     | メンバー変数名の表示は各階層の変数を「.」でスコープします。
     | 繰返配列の場合は「[ ]」で繰返位置(0～)をスコープします。繰返し配列の数は「 :ref:`ansible_legacy_nested_variable_list_ansible_legacy_role_only` 」で設定を行います。
     |
     | e.g.) 代入値自動登録設定で選択できるメンバー変数と変数ネスト管理で最大繰返数を更新後に選択できるメンバー変数の確認
     
     #. | 下記のようにロールパッケージの変数定義ファイル(defaults/main.yml)に変数を定義して、 :menuselection:`Ansible-LegacyRole-->ロールパッケージ管理` でロールパッケージを登録します。
        | **変数定義ファイルの記述内容**                                                         
                                                                                
        .. code-block:: yaml
  
           VAR_aaaa:
             - name: alice
               object: obj1
               directory: 
                 - craete_dir: /dir
               password:
                 - craete_pass: 
                   sample:
                     - sample_pass: pass1
                 - craete_pass: 
                   sample:
                     - sample_pass: pass2
               user:
                 root:
                   - craete_users: 
                     prod:
                       - prod_user: user1
                     dev:
                       - dev_user: user2
    
  
     #. | 1. のように変数を定義してロールパッケージを登録した場合、 :menuselection:`Ansible-LegacyRole-->変数ネスト管理` には下記のように登録され、 :menuselection:`Ansible-LegacyRole-->代入値自動登録設定` ではデフォルトで下記のメンバー変数が選択できます。
     
        .. list-table:: 変数ネスト管理の登録内容
           :widths: 40 30 30 
           :header-rows: 1
           :align: left
        
           * - 変数名
             - メンバー変数名
             - 最大繰返数
           * - VAR_aaaa
             - 0
             - 1
           * - VAR_aaaa
             - 0.directory
             - 1
           * - VAR_aaaa
             - 0.password  
             - 1
           * - VAR_aaaa
             - 0.password.sample
             - 1
           * - VAR_aaaa
             - 0.user.root 
             - 1
           * - VAR_aaaa
             - 0.user.root.dev
             - 1
           * - VAR_aaaa
             - 0.user.root.prod
             - 1
  
        .. list-table:: 代入値自動登録設定で選択可能なメンバー変数
           :widths: 40 50 
           :header-rows: 1
           :align: left
        
           * - 変数名
             - メンバー変数名
           * - VAR_aaaa
             - [0].directory[0].create_dir
           * - VAR_aaaa
             - [0].name  
           * - VAR_aaaa
             - [0].object 
           * - VAR_aaaa
             - [0].password[0].create_pass 
           * - VAR_aaaa
             - [0].password[0].sample[0].sample_pass
           * - VAR_aaaa
             - [0].user.root[0].create_users 
           * - VAR_aaaa
             - [0].user.root[0].dev[0].dev_user
           * - VAR_aaaa
             - [0].user.root[0].prod[0].prod_user
  
  
     #. | :menuselection:`Ansible-LegacyRole-->変数ネスト管理` でメンバー変数「0.user.root.prod」の最大繰返数を初期値"1"から"3"に更新します。
  
        .. list-table:: 変数ネスト管理の更新内容
           :widths: 40 30 30 
           :header-rows: 1
           :align: left
        
           * - 変数名
             - メンバー変数名
             - 最大繰返数
           * - VAR_aaaa
             - 0.user.root.prod  
             - 3
  
  
     #. | 3. のようにメンバー変数を更新した場合、 :menuselection:`Ansible-LegacyRole-->代入値自動登録設定` で選択できるメンバー変数も下記のように更新されます。
        | （メンバー変数 [0].user.root[0].prod[1].prod_user と [0].user.root[0].prod[2].prod_user がプルダウンに追加されました。）
  
        .. list-table:: 代入値自動登録設定で選択可能なメンバー変数
           :widths: 40 50 
           :header-rows: 1
           :align: left
        
           * - 変数名
             - メンバー変数名
           * - VAR_aaaa
             - [0].directory[0].create_dir 
           * - VAR_aaaa
             - [0].name  
           * - VAR_aaaa
             - [0].object 
           * - VAR_aaaa
             - [0].password[0].create_pass  
           * - VAR_aaaa
             - [0].password[0].sample[0].sample_pass 
           * - VAR_aaaa
             - [0].user.root[0].create_users 
           * - VAR_aaaa
             - [0].user.root[0].dev[0].dev_user
           * - VAR_aaaa
             - [0].user.root[0].prod[0].prod_user
           * - VAR_aaaa
             - [0].user.root[0].prod[1].prod_user
           * - VAR_aaaa
             - [0].user.root[0].prod[2].prod_user
  
  
  
.. _ansible_legacy_substitution:

.. note:: | **代入順序の入力**
  
   | Ansible-Legacy では、代入順序が未入力の場合は、通常変数として扱います。
   | 代入順序が入力されている場合は、複数具体値変数として扱います。複数具体値変数の場合は複数の
   | 具体値が必要ない場合(具体値が 1 個でよい)でも代入順序は入力してください。
   |
   | 変数名またはメンバー変数名を選択することで、複数具体値変数の場合のみ代入順序が入力可能となります。複数具体値変数の場合に入力してください。
   | 特定の複数具体値変数に対して代入順序が連続していなくても問題ありません。
   | 
   | e.g.)複数具体値変数に代入順序を入力して作業実行する場合
   
   #. | 下記のようにロールパッケージの変数定義ファイル(defaults/main.yml)に変数を定義して、 :menuselection:`Ansible-Legacy-->ロールパッケージ管理` でロールパッケージを登録します。                                                              
      | **変数定義ファイルの記述内容**

      .. code-block:: yaml

         VAR_substitutionA:
           - user-name
           - group-name
           - meta-name
         
         VAR_substitutionB:
           - login
           - authorized
           - space
           - cluster         
   
   #. | :menuselection:`Ansible-Legacy-->代入値自動登録設定` で紐付対象メニューに登録されている項目の設定値とRole内の変数を紐付けします。
   
      .. table:: 紐付対象メニュー(sample-menu)の登録内容
         :align: left
         
         +----------------+------------------------+-------------------------------------------+
         | ホスト名       | オペレーション名       | パラメータ                                |
         |                |                        +----------+----------+----------+----------+
         |                |                        | 項目1    | 項目2    | 項目3    | 項目4    |
         +================+========================+==========+==========+==========+==========+
         | test-host      | test-ope               | value1   | value2   | value3   | value4   |
         +----------------+------------------------+----------+----------+----------+----------+

      .. list-table:: 代入値自動登録設定の登録内容
         :widths: 40 20 30 20 
         :header-rows: 1
         :align: left
      
         * - メニュー名
           - 項目
           - 変数名
           - 代入順序
         * - sample-menu 
           - 項目1
           - VAR_substitutionA 
           - 3
         * - sample-menu 
           - 項目2 
           - VAR_substitutionA
           - 1 
         * - sample-menu 
           - 項目3 
           - VAR_substitutionA 
           - 2
         * - sample-menu 
           - 項目1 
           - VAR_substitutionB
           - 2 
         * - sample-menu 
           - 項目2
           - VAR_substitutionB
           - 4
         * - sample-menu 
           - 項目3 
           - VAR_substitutionB
           - 1 
         * - sample-menu 
           - 項目4 
           - VAR_substitutionB 
           - 3



   #. | 作業実行時、投入データ(InputData_xxxx.zip)内のホスト変数ファイル(host_vars/test-host)には、代入値自動登録設定で登録した変数が下記のように出力されます。
      | **ホスト変数ファイルへの出力内容**

      .. code-block:: yaml
   
         VAR_substitutionA: 
           - value2
           - value3
           - value1
         VAR_substitutionB: 
           - value3
           - value1
           - value4
           - value2

.. _host:

.. note:: | **ホスト変数ファイルへの出力**
   | 代入値自動登録設定で具体値を登録した変数のみが作業実行時にホスト変数ファイルへ出力されます。
   | 作業実行時に Playbook または対話ファイルで使用している変数の具体値が代入値管理に登録されていないと作業実行が想定外エラーとなります。

   | 
   | e.g.) 代入値自動登録設定で具体値を登録した変数と作業実行時にホスト変数ファイルに出力される変数の確認
   
   #. | 下記のようにロールパッケージの変数定義ファイル(defaults/main.yml)に変数を定義して、 :menuselection:`Ansible-LegacyRole-->ロールパッケージ管理` でロールパッケージを登録します。                                                              
      | **変数定義ファイルの記述内容**

      .. code-block:: yaml

         VAR_output:
           - name: alice
             group: root
             user:
               root:
                 - craete_users: 
                   prod:
                     - prod_user: user1
                   dev:
                     - dev_user: user2         
   
   #. | :menuselection:`Ansible-LegacyRole-->代入値自動登録設定` で紐付対象メニューに登録されている項目の設定値とRole内の変数を紐付けします。
   
      .. table:: 紐付対象メニュー(sample-menu)の登録内容
         :align: left
         
         +----------------+------------------------+---------------------+
         | ホスト名       | オペレーション名       | パラメータ          |
         |                |                        +----------+----------+
         |                |                        | 項目1    | 項目2    |
         +================+========================+==========+==========+
         | test-host      | test-ope               | value1   | value2   |
         +----------------+------------------------+----------+----------+

      .. list-table:: 代入値自動登録設定の登録内容
         :widths: 30 15 30 50 
         :header-rows: 1
         :align: left
      
         * - メニュー名
           - 項目
           - 変数名
           - メンバー変数名
         * - sample-menu 
           - 項目1
           - VAR_output 
           - [0].name 
         * - sample-menu 
           - 項目2 
           - VAR_output 
           - [0].user.root[0].dev[0].dev_user 


   #. | 作業実行時、投入データ(InputData_xxxx.zip)内のホスト変数ファイル(host_vars/test-host)には、代入値自動登録設定で登録した変数が下記のように出力されます。
      | **ホスト変数ファイルへの出力内容**

      .. code-block:: yaml
   
         VAR_output:
           - name: value1
             user:
               root:
               - dev:
                 - dev_user: value2


.. _ansible_legacy_file_and_templete:

.. note:: | **ファイル埋込変数とテンプレート埋込変数をPlaybookの変数に紐付して使用する例**
   | 「Ansible共通:ファイル管理:ファイル埋込変数名」「Ansible共通:テンプレート管理:テンプレート埋込変数名」をパラメータシートの項目として代入値自動登録設定で使用した場合、項目の設定値は選択されている変数名となり、紐付している変数の具体値は '{{ 変数名 }}' として代入値管理に反映されます。
   | ファイルパスはITAが作業実行時に配置したファイルパスをホスト変数経由でansibleが解釈し処理します。
   | e.g.) ファイル埋込変数 CPF_test とテンプレート埋込変数 TPF_sample を代入値自動登録設定でPlaybookの変数に紐付して使用する場合

   #. | :menuselection:`Ansible共通-->ファイル管理／テンプレート管理` で下記のように登録します。

      .. list-table:: ファイル管理の登録内容
         :widths: 50 40
         :header-rows: 1
         :align: left
      
         * - ファイル埋込変数名
           - ファイル素材
         * - CPF_test   
           - test_file.txt


      .. list-table:: テンプレート管理の登録内容
         :widths: 50 40
         :header-rows: 1
         :align: left
      
         * - テンプレート埋込変数名
           - テンプレート素材
         * - TPF_sample 
           - sample.tpl


   #. | :menuselection:`メニュー作成-->メニュー定義・作成` で「Ansible共通:ファイル管理:ファイル埋込変数名」「Ansible共通:テンプレート管理:テンプレート埋込変数名」をパラメータシートの項目としてメニュー作成後、 :menuselection:`入力用-->サンプルパラメータシート(メニュー名)` で項目の設定値としてファイル埋込変数とテンプレート埋込変数を登録します。
      

      .. figure:: /images/ja/menu_creation/menu_definition_and_create/legacyrole_menucreate.png
         :width: 800px
         :alt: メニュー定義・作成画面

         メニュー定義・作成画面


      .. table:: サンプルパラメータシート(メニュー名)の登録内容
         :align: left
         
         +----------------+------------------------+---------------------------------------+
         | ホスト名       | オペレーション名       | パラメータ                            |
         |                |                        +-----------------+---------------------+
         |                |                        | ファイル管理    | テンプレート管理    |
         +================+========================+=================+=====================+
         | test-host      | test-ope               | CPF_test        | TPF_sample          |
         +----------------+------------------------+-----------------+---------------------+

   #. | :menuselection:`Ansible-Legacy-->代入値自動登録設定` で2. のパラメータシートに登録した項目の設定値とPlaybookの変数を紐付して :menuselection:`Ansible-LegacyRole-->作業実行` で作業実行します。

      .. list-table:: 代入値自動登録設定の登録内容
         :widths: 50 30 30
         :header-rows: 1
         :align: left
      
         * - メニュー名
           - 項目
           - 変数名
         * - サンプルパラメータシート
           - ファイル管理 
           - VAR_filetest
         * - サンプルパラメータシート
           - テンプレート管理
           - VAR_temptest


   #. | :menuselection:`Ansible-Legacy-->作業状態確認` の :guilabel:`代入値確認` ボタンで具体値に '{{ CPF_test }}' '{{ TPF_sample }}' が反映されていることが確認できます。
      | また、作業実行後、作業対象サーバに1. で登録したファイル素材とテンプレート素材が設置されます。

      .. figure:: /images/ja/ansible-legacyrole/assigned_value_management/general_operations_note.png
         :width: 800px
         :alt: 作業状態確認の代入値確認画面

         作業状態確認の代入値確認画面
  

.. _ansible_legacy_execution:

作業実行
~~~~~~~~

| 作業の実行を指示します。Movement一覧、オペレーション一覧からそれぞれラジオボタンで選択し、 :guilabel:`作業実行` ボタンを押すと、「 :ref:`ansible_legacyrole_check_operation_status` 」に遷移し、実行されます。

.. figure:: /images/ja/ansible-legacyrole/execution/execution_screen.gif
   :width: 800px
   :alt: 作業実行画面

   作業実行画面

#. | **ドライラン**
   | 「ドライラン」ボタンをクリックすると、実際に対象機器に対して構築作業をせず、ドライランを行うことができます。
   | ドライランを行った場合の動作は、Ansible-Playbookコマンドの--checkパラメータを指定してroleを実行します。

    

#. | **予約日時の指定**
   | 「予約日時」を入力することで、実行を予約することがきます。
   | 「予約日時」には、未来の日時のみ登録可能です。



.. _ansible_legacy_check_operation_status:

作業状態確認
~~~~~~~~~~~~

| 作業の実行状態を監視します。

.. figure:: /images/ja/ansible-legacyrole/check_work_status/check_operation_status.png
   :width: 800px
   :alt: サブメニュー画面（作業状態確認）

   サブメニュー画面（作業状態確認）

#. | **実行状態表示**
   | 実行状況に即し、「ステータス」が表示されます。
   | また、実行ログ、エラーログに実行状況の詳細が表示されます。
   | 「実行種別」には、ドライランの場合は「ドライラン」、それ以外は「通常」が表示されます。
   | ステータスが想定外エラーで終了した場合、Webコンテンツの登録不備が原因であれば、エラーログにメッセージが表示されます。
   | また、「 :ref:`ansible_legacy_interface_information` 」の登録不備等で、Ansible RestAPIとの通信に失敗した場合にはエラーログにメッセージが表示されません。この場合は、アプリケーションログにエラー情報が記録されます。必要に応じてアプリケーションログを確認ください。
   | Conductorから実行した場合に、「呼出元Conductor」には、どのConductorから実行されたかを表示します。
   | Ansible-LegacyRoleドライバから直接実行した場合は空欄になります。
   | 「実行ユーザ」には、作業実行メニューより「実行」ボタンまたは「ドライラン」ボタンを押下した際のログインユーザが表示されます。

#. | **作業対象ホスト確認**
   | :guilabel:`作業対象ホスト確認` ボタンで「 :ref:`ansible_legacy_target_host` 」が表示され、作業対象のオペレーションとMovementに絞り込んだホストが表示されます。

#. | **代入値確認**
   | :guilabel:`代入値確認` ボタンで「 :ref:`ansible_legacy_substitution_value_list` 」が表示され、作業対象のオペレーションとMovementに絞り込んだ代入値が表示されます。

#. | **緊急停止/予約取り消し**
   | :guilabel:`緊急停止` ボタンで構築作業を停止させることができます。
   | また、実行前の「予約実行」の作業の場合は、 :guilabel:`予約取消` ボタンが表示されます。 :guilabel:`予約取消` ボタンで予約実行が取り消せます。

#. | **実行ログ表示**
   | Ansible Automation Controllerで実行した場合、構築対象機器の機器一覧のユーザー・パスワード・インスタンスグルーブなのどの項目値でグループ化された構築対象機器の単位でPlaybookが実行され、ansibleの実行ログが分割されます。
   | さらに、Movement一覧のオプションパラメータでジョブスライス数を指定することによりグループ化された構築対象機器をさらにジョブスライス数で分割しplaybookが実行され、ansibleの実行ログも分割されます。
   | 実行ログが分割された場合、表示ログファイルのプルダウンが表示され、表示したいログファイルを選択する事ができます。

   | 表示ログファイルのプルダウンに表示されるログファイル名は以下の2種類があります。
   | exec.log:　全ての実行ログをまとめたログファイルです。
   | exec.log以外: 分割された実行ログファイルです。ファイル命名規則は以下になります。
   | Ita_<mode名>_executions_jobtpl_<作業番号>_<グループ番号>_<通番>

   .. list-table:: 分割された実行ログファイルの命名要素
      :widths: 20 50
      :header-rows: 1
      :align: left
   
      * - 要素
        - 内容
      * - mode名
        - 実行したモード名 legacy_role 
      * - 作業番号 
        - 作業管理メニューの作業実行No 
      * - グループ番号
        - 構築対象機器の機器一覧のユーザー・パスワード・インスタンスグルーブなのどの項目値でグルーブ化した1からの通番です。
      * - 通番
        - | ジョブスライス数の設定によりグループ内を分割した1からの通番です。 
          | 0の場合はジョブスライス数による分割がなかったことのを表します。 
   
#. | **ログ検索**
   | 実行ログ、エラーログは、フィルタリングができます。各ログのフィルタのテキストボックスに検索したい文字列を入力し、「該当行のみ表示」のチェックボックスをチェックすることで該当する行だけが表示されます。
   | 実行ログ、エラーログのリフレッシュ表示間隔と最大表示行数を、「 :ref:`ansible_legacy_interface_information` 」の「状態監視周期（単位ミリ秒）」と「進行状態表示行数」で設定できます。

#. | **投入データ**
   | 実行したPlaybookなどをダウンロードすることができます。
   | 投入データの構成は「 :ref:`ansible_legacy_the_linkage_between_the_input_data_used_during_ansible_execution_and_ita_menu` 」を参照してください。

#. | **結果データ**
   | 実行ログ、エラーログなどをダウンロードすることができます。

.. _ansible_legacy_execution_list:

作業管理
~~~~~~~~

| 作業の履歴を閲覧できます。
| 条件を指定し :guilabel:`フィルタ` ボタンをクリックすると、作業一覧テーブルを表示します。
| :guilabel:`詳細` ボタンで :ref:`ansible_legacy_check_operation_status` に遷移し、実行状態の詳細を見ることができます。

.. figure:: /images/ja/ansible-legacyrole/work_management/execution_list.png
   :width: 800px
   :alt: サブメニュー画面（作業管理）


   サブメニュー画面（作業管理）



.. _ansible_legacy_target_host:

作業対象ホスト
~~~~~~~~~~~~~~

#. | :menuselection:`Ansible-LegacyRole-->作業対象ホスト` では、オペレーションに紐付くMovementおよびホストを閲覧できます。

   .. figure:: /images/ja/ansible-legacyrole/work_taget_host/target_host.png
      :width: 800px
      :alt: サブメニュー画面（作業対象ホスト）

      サブメニュー画面（作業対象ホスト）


#. | 閲覧画面の項目一覧は以下のとおりです。
   

#. | 閲覧画面の項目一覧は以下のとおりです。
   

   .. list-table:: 閲覧画面項目一覧（作業対象ホスト）
      :widths: 45 120 
      :header-rows: 1
      :align: left
   
      * - 項目
        - 説明
      * - 作業No
        - 作業実行時に自動採番した36桁の文字列が表示されます。
      * - オペレーション
        - オペレーション一覧に登録されているオペレーションが表示されます。
      * - Movement名
        - Movement一覧に登録されているMovementが表示されます。
      * - ホスト名
        - 機器一覧に登録されているホスト名が表示されます。 
      * - 備考  
        - 自由記述欄です。 


.. _ansible_legacy_substitution_value_list:

代入値管理
~~~~~~~~~~~~~~

#. | オペレーションに紐付くMovementで利用されるRole内の変数に代入する具体値を閲覧できます。


   .. figure:: /images/ja/ansible-legacyrole/assigned_value_management/substitution_value_list.png
      :width: 800px
      :alt: サブメニュー画面（代入値管理）

      サブメニュー画面（代入値管理）


#. | 閲覧画面の項目一覧は以下のとおりです。

   .. table:: 閲覧画面項目一覧（代入値管理）
      :align: left

      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | 項目                                      | 説明                                                                                                        | 
      +============+===========+==================+=============================================================================================================+
      | 作業No                                    | 作業実行時に自動採番した36桁の文字列が表示されます。                                                        |
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | オペレーション                            | 作業対象ホストに登録されているオペレーションが表示されます。                                                |
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | Movement名                                | 作業対象ホストに登録されているデータの中から、選択されたオペレーションに紐づくMovementが表示されます。      |
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | ホスト名                                  | 作業対象ホストに登録されているデータで選択されたオペレーションとMovementに紐づくホストが表示されます。      |
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | Movement名:変数名                         | Movement-ロール紐付に登録されている資材の中から、選択されたMovementにアタッチしている変数名が表示されます。 |
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | Movement名:変数名:メンバー変数            | 変数名で多段変数を選択した場合に多段変数のメンバー変数が表示されます。                                      | 
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | 具体値     | 文字列    | Sensitive設定    | 「OFF」または「ON」が表示されます。                                                                         |
      |            |           |                  |                                                                                                             |
      |            |           |                  | Ansibleに渡すホスト変数ファイルには、ansible-vaultで暗号化された内容が設定されます。                        |
      |            |           +------------------+-------------------------------------------------------------------------------------------------------------+
      |            |           | 値               | オペレーション/Movement/ホストで使用する変数の具体値が表示されます。                                        |
      |            |           |                  |                                                                                                             |
      |            |           |                  | 代入値自動登録設定でファイル埋込変数とテンプレート埋込変数をPlaybookの変数に紐付した場合、\                 |
      |            |           |                  | 具体値には '{{ CPF_xxxx }}' '{{ TPF_xxxx }}'が表示されます。                                                |
      |            +-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      |            | ファイル                     | オペレーション/Movement/ホストで使用する変数にファイルを埋込む場合に、埋込むファイルがアップロードされます。|
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | 代入順序                                  | 複数具体値が設定できる変数の場合のみ表示されます。                                                          |
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+
      | 備考                                      | 自由記述欄です。                                                                                            |
      +------------+-----------+------------------+-------------------------------------------------------------------------------------------------------------+




構築コード記述方法
==================

.. _ansible_legacy_write_playbook_ansible_legacy:

Playbook（Ansible-Legacy）の記述
--------------------------------

| 「 :ref:`ansible_legacy_playbook_file_list_ansible_legacy_only` 」でアップロードされたPlaybookは、ITAで生成するマスターPlaybookよりinclude形式で実行されます。
| ITAで作成するマスターPlaybookはへッダーセクションとtasksセクションで構成されます。

ヘッダーセクション
~~~~~~~~~~~~~~~~~~~~~
| アップロードアップロードするPlaybookにはヘッダーセクションは含む必要はありません。
| ヘッダーセクションは、デフォルト値が決まっていますが、「 :ref:`ansible_legacy_movement_list` 」のヘッダーセクションで変更することが出来ます。
|
| ▼ヘッダーセクションのデフォルト値について 
- | Ansible Coreの場合 

.. code-block:: yaml

   # ヘッダーセクションのデフォルト値　
     - hosts: all
       remote_user: "{{ __loginuser__ }}"
       gather_facts: no
       become: no

- | Ansible Automation Controllerの場合 

.. code-block:: yaml  

   # ヘッダーセクションのデフォルト値　
     - hosts: all                                                
       gather_facts: no                                         
       become: yes  

tasksセクション
~~~~~~~~~~~~~~~~ 

| アップロードされたPlaybookは、ITAで生成するマスタPlaybookよりinclude形式で実行されます。
| Playbook基本書式についてはAnsibleの公式マニュアルを参照してください。
|
| 例)

.. code-block:: yaml
   
   - name: コメント                                                     
     template:                                                          
       src:   "{{ item.src }}"                                         
       dest:  "{{ item.dest }}"                                          
       owner: "{{ item.owner is none |ternary('root', item.owner) }}"    
       group: "{{ item.group is none |ternary('bacula', item.group) }}"   
       mode:  "{{ item.mode is none |ternary('0654', item.mode) }}"


.. warning:: | Playbook内のインデントは2倍数で調整してください。
 | 文字コードは、UTF-8のBOMなしで作成してください。

| アップロードさたPlaybookは、「 :ref:`ansible_legacy_movement_details` 」のインクルード順序に従いincludeします。
   
.. figure:: /images/ja/diagram/legacy_session.png
   :align: center
   :width: 8.85417in
   :height: 6.67187in


BackYardコンテンツ
------------------

変数自動登録
~~~~~~~~~~~~~
| 変数解析対象の資材をアップロードした場合、アップロードされた資材から変数を取出します。

.. list-table:: モード別アップロードした資材の変数の扱い
   :widths: 25 10 
   :header-rows: 1
   :align: left

   * - メニュー    
     - Ansible-Legacy
   * - Playbook素材集 
     - ○
   * - ロールパッケージ管理
     - ×
   * - 対話ファイル素材集
     - ×

| なお、取出すタイミングは 自動プロセスの起動周期 に依存します。
..
  運用操作
  ========
  | 本機能を活用する操作は、クライアントPCのブラウザ画面からのユーザー利用による入力だけでなく、システム運用・保守による操作もあります。用意している運用・保守の操作は次のとおりです。

  メンテナンス
  ------------
  | Ansible-driverのプロセスの開始/停止/再起動に必要なファイルは以下となります。
  | {{#9: こちらの下記対象ファイルとコマンド実行の変更ありますでしょうか。}}

  .. table::
     :align: Left

     +--------------------------------------+-------------------------------+
     | **説明**                             | **対象ファイル名**            |
     +======================================+===============================+
     | LegacyRole実行監視                   | ky_ans\                       |
     |                                      | ible_execute-workflow.service |
     | 未実行作業の実行を行う。             |                               |
     +--------------------------------------+-------------------------------+
     | legacyRole変数自動登録               | ky_legacy_role_va\            |
     |                                      | rsautolistup-workflow.service |
     | アップロ\                            |                               |
     | ードした資材から変数の取出しを行う。 |                               |
     +--------------------------------------+-------------------------------+
     | legacyRole自動登録設定               | ky_legacy_role\               |
     |                                      | _valautostup-workflow.service |
     | 自動登録設定に設定された情報を代入値 |                               |
     | 管理と作業対象メニューに反映を行う。 |                               |
     +--------------------------------------+-------------------------------+
     | Ansible Automation\                  | ky_ansible_tow\               |
     | Controllerデータ同期                 | ermasterSync-workflow.service |
     |                                      |                               |
     | Ansible Automation\                  |                               |
     | Cont\                                |                               |
     | rollerから各種設定情報の取得を行う。 |                               |
     +--------------------------------------+-------------------------------+
   
   | 対象ファイルは「/usr/lib/systemd/system」に格納されています。
   | プロセス起動/停止/再起動の方法は次の通りです。
   | root権限でコマンドを実行してください。
   
   #. | プロセス起動
   
      .. code-block:: none
   
         # systemctl start ky_ansible_execute-workflow.service 
   
   
   #. | プロセス停止
   
      .. code-block:: none
   
         # systemctl stop ky_ansible_execute-workflow.service 
            
   #. | プロセス再起動
   
      .. code-block:: none
   
         # systemctl restart ky_ansible_execute-workflow.service 
   
   | 各対象ファイル名に置き換えて起動/停止/再起動を行ってください。

..
   {{開発メンバー確認時に不要のためコメントアウト}}

   .. _ansible_legacy_about_the_maintenance_method:
   メンテナンス方法について　 {{#10: こちらの下記ログレベル設定ファイル・コード変更ありますでしょうか。}}
   -------------------------------------------------------------------------------------------------------
   
   #. | NORMALレベルへの変更
      | 以下のファイルの8行目「DEBUG」を「NORMAL」に書き換えます。
      | ログレベル設定ファイル： <インストールディレクトリ>/ita-root/confs/backyardconfs/ita_env
   
   #. | DEBUGレベルへの変更
      | 以下のファイルの8行目「NORMAL」を「DEBUG」に書き換えます。
      | ログレベル設定ファイル： <インストールディレクトリ>/ita-root/confs/backyardconfs/ita_env
   
   #. | 起動周期の変更
      | 各対象ファイルのExecStartの5番目のパラメータを変更します。（単位:秒）
      | 例外を除き起動周期はデフォルト値の使用をしてください。
   
      .. code-block:: none
   
         ExecStart=/exastro/ita-root/backyards/common/ky_loopcall-php-procedure.sh /usr/local/bin/php /usr/local/bin/php /exastro/ita-root/backyards/ansible_driver/ky_pioneer_varsautolistup-workflow.php /exastro/ita-root/logs/backyardlogs 10 NORMAL > /dev/null 2>&1
   
      | 書き換え後、\ **プロセス再起動(restart)後に有効になります。**
      | ログファイルの出力先： *<インストールディレクトリ>/ita-root/logs/backyardlogs*
   
付録
====

.. _ansible_legacy_the_linkage_between_the_input_data_used_during_ansible_execution_and_ita_menu:

Ansible実行時に使用される投入データとITAメニューの紐づけ
--------------------------------------------------------
| 各ITAメニューより情報を抜出してAnsible実行に必要な投入データを作ります。この際、機器一覧のパスワードや代入値管理でSensitive設定をONした変数の具体値がansible-vaultで暗号化されています。
| 投入データはZIP形式で「 :ref:`ansible_legacy_check_operation_status` 」よりダウンロードが可能です。
| ダウンロードした投入データを所定のディレクトリに解凍することで、Ansibleを直接実行することも可能です。
| 
| 各種データとITAメニューの関係性は以下の通りです。

Ansible-Legacy投入データ
~~~~~~~~~~~~~~~~~~~~~~~~

.. list-table:: Ansible-Legacy投入データ
   :widths: 20 20 30 20
   :header-rows: 1
   :align: left

   * - メニューグループ     
     - メニュー
     - 項目
     - ディレクトリ解凍時のパス
   * - Ansible-Legacy     
     - Playbook素材集
     - プレイブック素材
     - /child_playbooks
   * - Ansible 共通     
     - テンプレート管理
     - テンプレート素材
     - /template_files
   * - Ansible 共通     
     - ファイル管理
     - ファイル素材
     - /copy_files
   * - Ansible-Legacy     
     - 代入値管理  
     - ファイル素材 
     - /upload_files 
   * - Ansible 共通     
     - グローバル変数管理
     - 変数名/具体値
     - /host_vars
   * - Ansible-Legacy     
     - 代入値管理
     - 変数名/具体値(文字列)   
     - /host_vars
   * - Ansible-Legacy     
     - 代入値管理 
     - 変数名/具体値(ファイル)
     - /host_vars
   * - Ansible-Legacy     
     - template 管理 
     - テンプレート素材 
     - /host_vars
   * - Ansible-Legacy    
     - ファイル管理
     - ファイル変数名
     - /host_vars
   * - Ansible共通     
     - 機器一覧  
     - プロトコル 
     - /host_vars
   * - Ansible共通     
     - 機器一覧  
     - ログインユーザ ID 
     - /host_vars
   * - Ansible共通     
     - 機器一覧  
     - | ログインパスワード
       | ※ansible-vault で暗号化 
     - /host_vars
   * - Ansible共通     
     - 機器一覧  
     - ホスト名   
     - /host_vars
   * - Ansible共通     
     - 機器一覧  
     - ssh 認証鍵ファイル   
     - /ssh_key_files 
   * - Ansible共通     
     - 機器一覧  
     - サーバ証明書    
     - /winrm_ca_files  
   * - Ansible共通     
     - インターフェース情報  
     - オプションパラメータ   
     - /AnsibleExecOption.txt  
   * - Ansible-Legacy   
     - Movement 一覧  
     - オプションパラメータ   
     - /AnsibleExecOption.txt  
   * - Ansible共通     
     - 機器一覧  
     - ログインユーザ ID   
     - /hosts   
   * - Ansible共通     
     - 機器一覧  
     - | ログインパスワード  
       | ※ansible-vault で暗号化 
     - /hosts   
   * - Ansible共通     
     - 機器一覧  
     - ホスト名   
     - /hosts   
   * - Ansible共通     
     - 機器一覧  
     - IP アドレス   
     - /hosts   
   * - Ansible共通     
     - 機器一覧  
     - インベントリファイル追加オプション     
     - /hosts   
   * - Ansible共通     
     - 機器一覧  
     - WinRM 接続情報     
     - /hosts   
   * - Ansible共通     
     - 機器一覧  
     - | 接続オプション  
       | ※ansible_ssh_extra_args の値     
     - /hosts   
   * - Ansible-Legacy    
     - Playbook 素材集  
     - プレイブック素材    
     - /playbook.yml  
   * - Ansible-Legacy   
     - | Movement-Playbook紐付 
       | （Movement-対話種別紐付、Movement-ロール紐付）
     - インクルード順序    
     - /playbook.yml  
   



..
   .. note:: | host_vars配下に格納されるデータリレイストレージパス(ITA)とConductor インスタンスデータリレイストレージパス(ANS)は、環境変数HOST_STORAGEPATHより情報を抜出します。
   
..
   {{開発メンバー確認時に不要のためコメントアウト}}

   投入データを直接実行する方法
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   ① 投入データの解凍先ディレクトリの作成　
   ***********************************************************************************************************************************
   | 以下の2つのディレクトリを作成し、1.のディレクトリに投入データを解凍します。
   #. | /ベースディレクトリ/ドライバパス/作業番号/in
   #. | /ベースディレクトリ/ドライバパス/作業番号/out
      | ベースディレクトリ　: インターフェース情報=>データリレイストレージパス(Ansible)
      | ドライバパス　:  Legacy-role: legacy/rl　 
      | 作業番号:　作業実行時に自動採番した36桁の文字列
   
   
   | 尚、投入データには、機器一覧にアップロードした秘密鍵ファイルが含まれていません。秘密鍵ファイルを必要といる認証方式の場合、投入データに含まれているインベントリファイル「hosts」を開き、ansible_ssh_private_key_fileに設定されているパスに秘密鍵ファイルをコピーしてください。
   
   | インベントリファイル「hosts」
   
   .. code-block:: none
   
      all:
        children:
          hostgroups:
            hosts:
              target_host_1:
                ansible_ssh_user: keyauth_user
                ansible_ssh_private_key_file: /exastro/data_relay_storage/ansible_driver/legacy/ns/0000000060/in/ssh_key_files/0000000006-keyauth_user_id_rsa
   
       
   ② 投入データを直接実行するコマンド
   ***********************************
   | Ansible-LegacyRole
   
   .. code-block:: none
      
      ansible-playbook (オプション) –i hosts --vault-password-file　パスワードファイル site.yml
   
   .. 
     ② 投入データを直接実行するコマンド
     ***********************************
     | Ansible-Legacy
     | 　　   ansible-playbook (オプション) –i hosts --vault-password-file　パスワードファイル playbook.yml
     | Ansible-Pioneer
     | 　　   ansible-playbook (オプション) –i hosts --vault-password-file　パスワードファイル playbook.yml
     | Ansible-LegacyRole
     | 　　   ansible-playbook (オプション) –i hosts --vault-password-file　パスワードファイル site.yml
     |
   
   .. note:: | パスワードファイル名は任意です。パスワードファイルに設定するパスワードは、ＩＴＡインストール先/ita-root/confs/commonconfs/ansible_vault_accesskey.txtの内容を、rot13、base64の順でデコードした値を使用してください。
   
Ansible実行時に作成される結果データ
-----------------------------------
| [投入データ]をansibleで実行した結果を[結果データ]としてZIP形式で保存します。
| [結果データ]はZIP形式で「 :ref:`ansible_legacy_check_operation_status` 」よりダウンロードが可能です。


Legacy結果データに保存されるファイル一覧
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

.. list-table:: Ansible-Legacy結果データに保存されるファイル一覧
   :widths: 20 50 20 20
   :header-rows: 1
   :align: left

   * - ファイル名     
     - 記録内容
     - Ansible Coreの場合
     - Ansible Automation Controllerの場合
   * - result.txt    
     - Ansibleの実行結果を記録
     - 〇
     - 
   * - xxx.pid  
     - | Ansible-playbbokコマンドのプロセスIDを記録するファイル
       | xxx:Ansible-playbbokコマンドのプロセスID
     - 〇
     - 
   * - error.log
     - | 作業実行時にITAがなにかしらのエラーによりエラーメッセージを出力した場合、または、Ansible-playbbokコマンドがなにかとらのエラーによりエラーメッセージを出力した場合のエラー出力先ファイル
       | 作業実行確認のエラーログに表示に表示される内容
     - 〇
     - 〇
   * - exec.log 
     - | Ansible-playbbokが出力した実行ログを一部加工したログファイル
       | 作業実行確認の実行ログに表示される内容
     - 〇
     - 〇
   * - exec.log.org
     - Ansible-playbbokが出力した実行ログ
     - 〇
     - 〇
   * - Ita_<mode名>_executions_jobtpl_<作業番号>_<グループ番号>
     - | 分割された実行ログファイル
       | ファイル名の命名規則は :ref:`ansible_legacyrole_check_operation_status` の実行ログ表示を参照してください。
     - 
     - 〇
   * - forced.txt
     - 緊急停止をした場合の記録ファイル
     - 〇
     - 
   * - user_files
     - 実行したplaybookでITA独自変数「\__\workflowdir\__\」になにかしらのファイル出力をした場合のファイルが記録されるディレクトリ。
     - 〇
     - 〇




.. table:: Legacy結果データの保存されるファイル一覧
   :align: Left

   +---------------+-----------------------------------------+----+------+
   | **ファ\       | **記録内容**                            | A\ | Ans\ |
   | イル名**      |                                         | ns\| ible\|
   |               |                                         | ib\| Au\  |
   |               |                                         | le\| toma\|
   |               |                                         | Co\| tion\|
   |               |                                         | re\| Co\  |
   |               |                                         | の\| ntro\|
   |               |                                         | 場\| ller\|
   |               |                                         | 合 | の\  |
   |               |                                         |    | 場合 |
   +===============+=========================================+====+======+
   | result.txt    | Ansibleの実行結果を記録                 | 〇 |      |
   +---------------+-----------------------------------------+----+------+
   | xxx.pid       | Ansible-playbbokコ\                     | 〇 |      |
   |               | マンドのプロセスIDを記録するファイル。  |    |      |
   |               |                                         |    |      |
   |               | x\                                      |    |      |
   |               | xx:Ansible-playbbokコマンドのプロセスID |    |      |
   +---------------+-----------------------------------------+----+------+
   | error.log     | 作業実行時にITAがなにかしらのエラ\      | 〇 | 〇   |
   |               | ーによりエラーメッセージを出力した場合\ |    |      |
   |               | 、または、Ansible-playbbokコマンドがな\ |    |      |
   |               | にかとらのエラーによりエラーメッセージ\ |    |      |
   |               | を出力した場合のエラー出力先ファイル。  |    |      |
   |               |                                         |    |      |
   |               | 作業実行確\                             |    |      |
   |               | 認のエラーログに表示に表示される内容。  |    |      |
   +---------------+-----------------------------------------+----+------+
   | exec.log      | Ansible-playbbokが出力した\             | 〇 | 〇   |
   |               | 実行ログを一部加工したログファイル。作\ |    |      |
   |               | 業実行確認の実行ログに表示される内容。  |    |      |
   +---------------+-----------------------------------------+----+------+
   | exec.log.org  | Ansible-playbbokが出力した実行ログ      | 〇 | 〇   |
   +---------------+-----------------------------------------+----+------+
   | I             | 分割された実行ログファイルです。        |    | 〇   |
   | ta_<mode名>\_ |                                         |    |      |
   |               | ファイル名の命名規則は :ref:`gen\       |    |      |
   | execut        | eral_operations_check_operation_stat\   |    |      |
   | ions_jobtpl\_ | us` の⑥実行ログ表示を参照してください。|    |      |
   |               |                                         |    |      |
   | <作業番号>_<  |                                         |    |      |
   | グループ番号> |                                         |    |      |
   +---------------+-----------------------------------------+----+------+
   | forced.txt    | 緊急停止をした場合の記録ファイル        | 〇 |      |
   +---------------+-----------------------------------------+----+------+
   | user_files    | 実行したplaybook\                       | 〇 | 〇   |
   |               | でITA独自変数「__workflowdir__」\       |    |      |
   |               | になにかしらのファイル出力をした場\     |    |      |
   |               | 合のファイルが記録されるディレクトリ。  |    |      |
   +---------------+-----------------------------------------+----+------+


.. _ansible_legacy_option_parameter_list:

オプションパラメータ一覧
------------------------

.. include:: ../../include/ansible_option_option_parameter_list.rst


Ansible Automation ControllerでITA独自変数を利用する場合の留意事項
--------------------------------------------------------------------------------------------------------------------

.. include:: ../../include/ansible_option_using-ita-proprietary-variables-in-aac.rst


.. _ansible_legacy_data_resources_deleted_when_executing:

実行時データ削除で削除されるデータリソース 
-------------------------------------------

.. include:: ../../include/ansible_option_data-resources-deleted.rst


..
   {{開発メンバー確認時に不要のためコメントアウト}}
  Ansible利用ガイドラインITA追加ルール
  ------------------------------------
  | ITAを使用して、Ansibleで実行する為のPlaybook作成ガイドラインを記述します。
  | 詳しくは、別資料「利用手順マニュアル_Ansible-driver_別紙_Ansible利用ガイドライン_追加ルール」を参照してください。

  運用操作
  ========
  | 本機能を活用する操作は、クライアントPCのブラウザ画面からのユーザー利用による入力だけでなく、システム運用・保守による操作もあります。用意している運用・保守の操作は次のとおりです。

  メンテナンス
  ------------
  | Ansible-driverのプロセスの開始/停止/再起動に必要なファイルは以下となります。
  | {{#9: こちらの下記対象ファイルとコマンド実行の変更ありますでしょうか。}}

  .. table::
     :align: Left

     +--------------------------------------+-------------------------------+
     | **説明**                             | **対象ファイル名**            |
     +======================================+===============================+
     | LegacyRole実行監視                   | ky_ans\                       |
     |                                      | ible_execute-workflow.service |
     | 未実行作業の実行を行う。             |                               |
     +--------------------------------------+-------------------------------+
     | legacyRole変数自動登録               | ky_legacy_role_va\            |
     |                                      | rsautolistup-workflow.service |
     | アップロ\                            |                               |
     | ードした資材から変数の取出しを行う。 |                               |
     +--------------------------------------+-------------------------------+
     | legacyRole自動登録設定               | ky_legacy_role\               |
     |                                      | _valautostup-workflow.service |
     | 自動登録設定に設定された情報を代入値 |                               |
     | 管理と作業対象メニューに反映を行う。 |                               |
     +--------------------------------------+-------------------------------+
     | Ansible Automation\                  | ky_ansible_tow\               |
     | Controllerデータ同期                 | ermasterSync-workflow.service |
     |                                      |                               |
     | Ansible Automation\                  |                               |
     | Cont\                                |                               |
     | rollerから各種設定情報の取得を行う。 |                               |
     +--------------------------------------+-------------------------------+
   
   | 対象ファイルは「/usr/lib/systemd/system」に格納されています。
   | プロセス起動/停止/再起動の方法は次の通りです。
   | root権限でコマンドを実行してください。
   
   #. | プロセス起動
   
      .. code-block:: none
   
         # systemctl start ky_ansible_execute-workflow.service 
   
   
   #. | プロセス停止
   
      .. code-block:: none
   
         # systemctl stop ky_ansible_execute-workflow.service 
            
   #. | プロセス再起動
   
      .. code-block:: none
   
         # systemctl restart ky_ansible_execute-workflow.service 
   
   | 各対象ファイル名に置き換えて起動/停止/再起動を行ってください。

..
   {{開発メンバー確認時に不要のためコメントアウト}}

   .. _ansible_legacyrole_about_the_maintenance_method:
   メンテナンス方法について　 {{#10: こちらの下記ログレベル設定ファイル・コード変更ありますでしょうか。}}
   -------------------------------------------------------------------------------------------------------
   
   #. | NORMALレベルへの変更
      | 以下のファイルの8行目「DEBUG」を「NORMAL」に書き換えます。
      | ログレベル設定ファイル： <インストールディレクトリ>/ita-root/confs/backyardconfs/ita_env
   
   #. | DEBUGレベルへの変更
      | 以下のファイルの8行目「NORMAL」を「DEBUG」に書き換えます。
      | ログレベル設定ファイル： <インストールディレクトリ>/ita-root/confs/backyardconfs/ita_env
   
   #. | 起動周期の変更
      | 各対象ファイルのExecStartの5番目のパラメータを変更します。（単位:秒）
      | 例外を除き起動周期はデフォルト値の使用をしてください。
   
      .. code-block:: none
   
         ExecStart=/exastro/ita-root/backyards/common/ky_loopcall-php-procedure.sh /usr/local/bin/php /usr/local/bin/php /exastro/ita-root/backyards/ansible_driver/ky_pioneer_varsautolistup-workflow.php /exastro/ita-root/logs/backyardlogs 10 NORMAL > /dev/null 2>&1
   
      | 書き換え後、\ **プロセス再起動(restart)後に有効になります。**
      | ログファイルの出力先： *<インストールディレクトリ>/ita-root/logs/backyardlogs*
   
..
   {{開発メンバー確認時に不要のためコメントアウト}}

   投入データを直接実行する方法
   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
   ① 投入データの解凍先ディレクトリの作成　
   ***********************************************************************************************************************************
   | 以下の2つのディレクトリを作成し、1.のディレクトリに投入データを解凍します。
   #. | /ベースディレクトリ/ドライバパス/作業番号/in
   #. | /ベースディレクトリ/ドライバパス/作業番号/out
      | ベースディレクトリ　: インターフェース情報=>データリレイストレージパス(Ansible)
      | ドライバパス　:  Legacy-role: legacy/rl　 
      | 作業番号:　作業実行時に自動採番した36桁の文字列
   
   
   | 尚、投入データには、機器一覧にアップロードした秘密鍵ファイルが含まれていません。秘密鍵ファイルを必要といる認証方式の場合、投入データに含まれているインベントリファイル「hosts」を開き、ansible_ssh_private_key_fileに設定されているパスに秘密鍵ファイルをコピーしてください。
   
   | インベントリファイル「hosts」
   
   .. code-block:: none
   
      all:
        children:
          hostgroups:
            hosts:
              target_host_1:
                ansible_ssh_user: keyauth_user
                ansible_ssh_private_key_file: /exastro/data_relay_storage/ansible_driver/legacy/ns/0000000060/in/ssh_key_files/0000000006-keyauth_user_id_rsa
   
       
   ② 投入データを直接実行するコマンド
   ***********************************
   | Ansible-LegacyRole
   
   .. code-block:: none
      
      ansible-playbook (オプション) –i hosts --vault-password-file　パスワードファイル site.yml
   
   .. 
     ② 投入データを直接実行するコマンド
     ***********************************
     | Ansible-Legacy
     | 　　   ansible-playbook (オプション) –i hosts --vault-password-file　パスワードファイル playbook.yml
     | Ansible-Pioneer
     | 　　   ansible-playbook (オプション) –i hosts --vault-password-file　パスワードファイル playbook.yml
     | Ansible-LegacyRole
     | 　　   ansible-playbook (オプション) –i hosts --vault-password-file　パスワードファイル site.yml
     |
   
   .. note:: | パスワードファイル名は任意です。パスワードファイルに設定するパスワードは、ＩＴＡインストール先/ita-root/confs/commonconfs/ansible_vault_accesskey.txtの内容を、rot13、base64の順でデコードした値を使用してください。



