========
収集機能
========

はじめに
========

| 本書では、ITAの機能および操作方法について説明します。

収集機能概要
============

| 本章では収集機能について説明します。

収集機能について
----------------

| 収集機能とは、ITAで実施した、作業実行結果（規定のフォーマットで出力されたソースファイル）を元に、パラメータシートへ値を自動で登録する機能です。
| 本機能は、Ansible-Driverを対象としています。
| Ansibleの詳細情報については、「Ansibleの製品マニュアル」を参照してください。
| Ansible-Driverの詳細情報については、「利用手順マニュアルAnsible-driver」を参照してください。
| パラメータシートの詳細については、「利用手順マニュアルメニュー作成機能」を参照してください。

収集機能概要図
~~~~~~~~~~~~~~
| 以下は、収集機能実行までの全体の概要図です。

.. image:: /images/ja/ansible_common/collect_flow/overview.png
   :alt: 収集機能概要図
   :width: 6.00372in
   :height: 2.87662in


収集機能データ登録処理概要図
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

| 以下は、収集機能のデータ登録処理の概要図です。

.. image:: /images/ja/ansible_common/collect_flow/overview2.png
   :alt: 収集機能データ登録処理概要図
   :width: 6.00372in
   :height: 2.87662in

| ※収集機能のデータ型の取り扱い例については、「\ **7.2.2収集対象ファイルの値の取り扱い**\ 」をご参照ください。

パラメータシートへの登録方法について
------------------------------------

| 収集機能は、ITAのオプションとして機能し、ITAの標準RESTAPI機能を利用してパラメータシートへの登録処理を実施します。
| RESTAPI機能の詳細については、「利用手順マニュアル_RestAPI」を参照してください。


収集機能の動作要件
~~~~~~~~~~~~~~~~~~

| ITAで以下の設定がされている必要があります。

- | ITA インストーラにて、「createparam」、「ansible_driver」が選択され、インストールされている
- | メニュー定義/作成にて、パラメータシート（ホスト/オペレーションあり）が作成されている 
- |  設定値項目管理にて、登録情報（ソースファイル）とパラメータシートの項目と紐づけ設定がされている
- | 収集インターフェース情報のRESTアクセス情報を更新済み
- | 収集対象機器（ホスト名）が、機器一覧に登録済み

| 作業実行後に、以下の状態である場合、パラメータシートへの登録を実施します。

- | 作業実行の結果、正常に完了している
- | 作業実行の出力結果として、規定の構造でディレクトリ、ファイルが配置されている



| ※パラメータシートへの登録元となるソースファイルを生成するIaC（Playbook、Role）については、各ユーザー様で準備する必要があります。

| 参考： Ansible Playbook Collection（OS設定収集）
| https://github.com/exastro-suite/playbook-collection-docs/blob/master/README.ja.md

収集機能でのディレクトリ、ファイル構造、変数取り扱い
====================================================

収集対象ディレクトリ、ファイル構造
----------------------------------

1.  収集対象のファイルフォーマット

    #. | Yaml形式で出力されたファイル
    
       .. code-block:: yaml

          :name: RH_snmp.yaml
          
          e.g.)
          ■ファイル名：RH_snmp.yml
          ■ファイルの内容：
          VAR_RH_sshd_config:
            - key: PermitRootLogin
              value: yes    
            - key: PasswordAuthentication
              value: no
  



2.  収集対象ディレクトリ構造


| 収集対象ディレクトリについて、収集対象ディレクトリパス（ソースファイルの出力先として）をIaC(Playbook,Role)内にて、で以下の変数として扱えます。


.. list-table:: 表 2-1 収集機能対象ディレクトリITA 独自変数
   :widths: 10 15 3
   :header-rows: 1
   :align: left   

   * - ITA独自変数
     - 変数指定内容
     - 備考 
   * - __parameter_dir__
     -  作業結果ディレクトリ配下の「_parameters」のパス  
     -  
   * - __parameters_file_dir__	
     -  作業結果ディレクトリ配下の「_parameters_file」のパス 
     -  
   * -  __parameters_dir_for_epc__
     -  作業ディレクトリ配下の「_parameters」のパス
     -  
   * - __parameters_file_dir_for_epc__
     -  作業ディレクトリ配下の「_parameters_file」のパス
     -  

| 収集対象のディレクトリ（_parameters）の上位ディレクトリのパスについて、「Ansible共通」-「インターフェース情報」の「データリレイストレージパス(Ansible)」、Ansible-Driverの実行モード、実施した作業Noに依存します。


.. code-block:: bash
   :caption: 上位ディレクトリ

   |-  _parameters           ※1
   |   |-  localhost         ※2
   |       |-  SAMPLE.yml    ※3
   |-  _parameters_file      ※4
   |   |-  localhost         ※2
           |-  test.txt      ※5

| ※データリレイストレージパス(Ansible)以降の階層構造

- 備考
  
| ※1 収集対象ディレクトリ（名称固定）
| ※2ホスト名（機器一覧に登録されているものが収集対象）
| ※3 収集対象ファイル
| ※4収集対象ディレクトリファイルアップロード用（名称固定）
| ※5ファイルアップロード対象ファイル


.. 上記の方が綺麗に見えたため修正(下記は、念のため残しています。)
.. .. table:: 2-2 収集機能対象ディレクトリ、ファイル階層

      +--------------------------+------------------------------------------+
      | 階層構造                 | 備考                                     |
      +==========================+==========================================+
      | 【上位ディレクトリ】     | ※1 収集対象ディレクトリ（名称固定）      |
      |                          |                                          |
      | \|- \_parameters   ※1    | ※2ホスト名                               |
      |                          |                                          |
      | \|  \|- localhost ※2     | （                                       |
      |                          | 機器一覧に登録されているものが収集対象） |
      | \|  \|- \|- SAMPLE.yml ※3|                                          |
      |                          | ※3 収集対象ファイル                      |
      | \|- \_parameters_file ※4 |                                          |
      |                          | ※4 収集対象ディレ                        |
      | \|  \|- localhost ※2     | クトリファイルアップロード用（名称固定） |
      |                          |                                          |
      | \|  \|- \|- test.txt ※5  | ※5ファイルアップロード対象ファイル       |
      +--------------------------+------------------------------------------+




| ソースファイルを生成するPlaybookを作成する際、の出力先について、「表 2-1 収集機能対象ディレクトリITA独自変数」を使用しない場合、以下の構造を認識してPlaybookを記述する必要があります。

.. list-table:: 表 2-3 Ansible-Driverモード別上位ディレクトリパス
   :widths: 5 5 15 3
   :header-rows: 1
   :align: left   

   * - モード
     - モード別識別子
     - 階層構造
     - 備考 
   * - Ansible-Legacy 
     - legacy/ns/
     - /データリレイストレージパス(Ansible）/legacy/ns/
     -     
   * - Ansible-Pioneer
     - pioneer/ns/
     - /データリレイストレージパス(Ansible）/pioneer /ns/
     -  
   * - Ansible-LegacyRole
     - legacy/rl/
     - /データリレイストレージパス(Ansible）/legacy/rl/
     -  


+----------------------------------------------------------------------+
| e.g.)　収集対象ファイルのファイルパス、ディレクトリ構造              |
|                                                                      |
| 実行モード： Ansible-Legacy                                          |
|                                                                      |
| 作業No ： 1                                                          |
|                                                                      |
| 対象ホスト： localhost                                               |
|                                                                      |
| 作業実行ディレク                                                     |
| トリ；/データリレイストレージパス(Ansible）/legacy/ns/0000000001/in/ |
|                                                                      |
| 作業結果ディレクト                                                   |
| リ；/データリレイストレージパス(Ansible）/legacy/ns/0000000001/out/  |
|                                                                      |
| 収集対象ファイルパス、ディレクトリ構造：                             |
|                                                                      |
| /データリレイストレージパス                                          |
| (Ansible）/legacy/ns/0000000001/in/_parameters/localhost/SAMPLE.yml  |
|                                                                      |
| /データリレイストレージパス(Ans                                      |
| ible）/legacy/ns/0000000001/in/_parameters/localhost/OS/RH_snmpd.yml |
|                                                                      |
| /データリレイストレージパス(A                                        |
| nsible）/legacy/ns/0000000001/in/_parameters_file/localhost/TEST.txt |
|                                                                      |
| もしくは、                                                           |
|                                                                      |
| /データリレイストレージパス                                          |
| (Ansible）/legacy/ns/0000000001/out/_parameters/localhost/SAMPLE.yml |
|                                                                      |
| /データリレイストレージパス(Ansi                                     |
| ble）/legacy/ns/0000000001/out/_parameters/localhost/OS/RH_snmpd.yml |
|                                                                      |
| /データリレイストレージパス(An                                       |
| sible）/legacy/ns/0000000001/out/_parameters_file/localhost/TEST.txt |
+----------------------------------------------------------------------+


| ファイルアップロードのメニューを収集対象とする場合、ソースファイルの変数の値（ファイル名/ファイルパス）と該当するファイル、が_parameters_file配下に配置されている必要があります。
| 収集項目値管理の設定は、「5.1.2 収集項目値管理」参照してください。
| ファイルアップロードの最大ファイルサイズについて、サーバースペックに依存するため、詳細は、「利用手順マニュアル_RestAPI」を参照してください。
| \_parameters_file配下に配置されているアップロード対象ファイルの指定方法として、以下の記載方法があります。


.. list-table:: 表  2-4 アップロード対象ファイルの指定方法
   :widths: 5 15 3
   :header-rows: 1
   :align: left  

   * - 指定方式
     - YAMLファイルへの記載方法
     - 備考 
   * - ファイル名指定
     - VAR_FILE_NAME : <‘ファイル名> ’
     - 
   * - ファイルパス指定 (完全一致)
     - VAR_FILE_NAME : ‘/<上位ディレクトリ>/_parameters_file/ localhost/<階層X>/<ファイル名>’ 
     - 
   * - ファイルパス指定 (後方一致)
     - VAR_FILE_NAME : ‘/<階層X>/<ファイル名>’
     - 


| ※ファイル名指定時、該当するファイルが複数存在する場合、対象となるファイルは、ランダムとなります。
| ファイルパス指定(完全一致)時、該当するパスにあるファイルとなります。
| ファイルパス指定(後方一致)時、該当するファイルが複数ある場合、対象となるファイルは、ランダムとなります。

| ■　e.g.) 通常変数の構造の変数の場合のディレクトリ構造とソースファイルの内容 

.. code-block:: bash

   ■構造
  【上位ディレクトリ】
      |-  _parameters              
      |   |-  localhost             
      |       |-  SAMPLE.yml             ※ソースファイル
      |-  _parameters_file         
      |   |-  localhost             
      |      |-  test.txt                ※アップロード対象ファイル
      |      |-  APP001             
                |-  config               ※アップロード対象ファイル

   ■収集対象ファイル名：SAMPLE.yml     
   ■ファイルの内容
   VAR_upload_file: test.txt

   VAR_upload_fileX: config
   VAR_upload_fileY: ‘/<上位ディレクトリ>/_parameters_file /localhost /APP001/config’
   VAR_upload_fileZ: ‘/APP001/config       

.. +----------------------------------------------------------------------+
   | e.g.)                                                                |
   | 通常変数の構造の変数の場合のディレクトリ構造とソースファイルの内容   |
   |                                                                      |
   | ■構造                                                                |
   |                                                                      |
   | 【上位ディレクトリ】                                                 |
   |                                                                      |
   | \|- \_parameters                                                     |
   |                                                                      |
   | \| \|- localhost                                                     |
   |                                                                      |
   | \| \|- SAMPLE.yml ※ソースファイル                                    |
   |                                                                      |
   | \|- \_parameters_file                                                |
   |                                                                      |
   | \| \|- localhost                                                     |
   |                                                                      |
   | \| \|- test.txt ※アップロード対象ファイル                            |
   |                                                                      |
   | \| \|- APP001                                                        |
   |                                                                      |
   | \|- config ※アップロード対象ファイル                                 |
   |                                                                      |
   | ■収集対象ファイル名：SAMPLE.yml                                      |
   |                                                                      |
   | ■ファイルの内容                                                      |
   |                                                                      |
   | VAR_upload_file: test.txt                                            |
   |                                                                      |
   | VAR_upload_fileX: config                                             |
   |                                                                      |
   | VAR_upload_fileY: ‘/<上位ディレクトリ>/_parameters_file /localhost   |
   | /APP001/config’                                                      |
   |                                                                      |
   | VAR_upload_fileZ: ‘/APP001/config’                                   |
   +----------------------------------------------------------------------+

取り扱う変数と種類
------------------

| 収集機能で扱うソースファイル内で扱える変数は以下の3種類があります。

.. table:: 表 2.1 変数の種類

   +----------------+--------------------------------------------+------+
   | 種類           | 内容                                       | 備考 |
   +================+============================================+======+
   | 通常変数       | 変数\                                      |      |
   |                | 名に対して具体値を1つ定義できる変数です。  |      |
   |                |                                            |      | 
   |                | e.g.)                                      |      |
   |                |                                            |      |
   |                | .. code-block:: yaml                       |      |
   |                |                                            |      |
   |                |    VAR_users: root                         |      |
   +----------------+--------------------------------------------+------+
   | 複数具体値変数 | 変数\                                      |      |
   |                | 名に対して具体値を複数定義できる変数です。 |      |
   |                |                                            |      |
   |                | e.g.)                                      |      |
   |                |                                            |      |
   |                | .. code-block:: yaml                       |      |
   |                |                                            |      | 
   |                |    VAR_users:                              |      |
   |                |      - root                                |      |
   |                |      - mysql                               |      |
   +----------------+--------------------------------------------+------+
   | 多段変数       | 階層化された変数です。                     |      |
   |                |                                            |      |
   |                |                                            |      |
   |                | e.g.)                                      |      |
   |                |                                            |      |   
   |                | .. code-block:: yaml                       |      |
   |                |                                            |      |
   |                |    VAR_users:                              |      |
   |                |      - user-name: alice      #メンバ変数   |      |
   |                |        authorized: password                |      |
   |                |                                            |      |
   |                | | 変数名は、下記の7文字を除くascii文字\    |      |
   |                |  (0x20～0x7e)が使用出来ます。              |      |
   |                | |  " . [ ] ' \\ :                          |      |
   |                |                                            |      |
   |                | | 尚、コーテーショ\                        |      |
   |                |   ンで囲まないと変数名の先頭に使用出来\    |      |
   |                |   ない文字がいくつかあります。             |      |
   |                | | 詳しくは、Ansibleドキュメント\           |      |
   |                |     \ `Yaml\                               |      |
   |                |  synt\                                     |      |
   |                |  ax <https://docs.ansible.com/ansible      |      |
   |                |  /latest/reference_appendices/YAMLSyn      |      |
   |                |  tax.html#gotchas>`__\ を参照下さい。      |      |
   +----------------+--------------------------------------------+------+

収集機能 コンソールメニュー構成
===============================

| 本章では、ITAコンソールのメニュー構成について説明します。

メニュー/画面一覧
-----------------

1.  Ansible共通コンソールのメニュー

| Ansible共通コンソールのメニュー一覧を以下に記述します。

.. table:: 表 3-1共通コンソール メニュー/画面一覧

   +----+------------------+--------------------+--------------------+
   | No | メニューグループ | メニュー・画面     | 説明               |
   +====+==================+====================+====================+
   | 1  | Ansible共通\     | 収集イ\            | パラメータシート\  |
   |    |                  | ンターフェース情報 | へのデータの登録時\|
   |    | コンソール       |                    | に使用する、ITA標\ |
   |    |                  |                    | 準REST機能にアクセ\|
   |    |                  |                    | スするサーバへの接\|
   |    |                  |                    | 続インターフェース\|
   |    |                  |                    | 情報を管理します。 |
   +----+                  +--------------------+--------------------+
   | 2  |                  | 設定項目値管理     | 作\                |
   |    |                  |                    | 業実行の出力結果（\|
   |    |                  |                    | ソースファイル）と\|
   |    |                  |                    | 、パラメータシート\|
   |    |                  |                    | の項目の紐づけ設定\|
   |    |                  |                    | を行い、収集機能で\|
   |    |                  |                    | 登録する対象パラメ\|
   |    |                  |                    | ータを管理します。 |
   +----+------------------+--------------------+--------------------+


2. Ansibleコンソールのメニュー

| 各Ansibleコンソールに対応するメニュー一覧を以下に記述します。

.. table:: 表 3-2 Ansible driverコンソール メニュー/画面一覧

   +----+-----------------------------------+----------+-----------+
   | No | メニュー                          | メニュ\  | 説明      |
   |    | グループ                          | ー・画面 |           |
   |    +-----------------------------------+          |           |
   |    | Ansible\                          |          |           |
   |    | コン\                             |          |           |
   |    | ソール                            |          |           |
   |    +-----------+-----------+-----------+          |           |
   |    | Legacy    | Legacy\   | Pioneer   |          |           |
   |    |           | Role      |           |          |           |
   +====+===========+===========+===========+==========+===========+
   | 14 | **○**     | **○**     | **○**     | 作業管理 | 作業実行\ |
   |    |           |           |           |          | 履歴を管\ |
   |    |           |           |           |          | 理します。|
   |    |           |           |           |          |           |
   |    |           |           |           |          | 収集機能\ |
   |    |           |           |           |          | によるパ\ |
   |    |           |           |           |          | ラメータ\ |
   |    |           |           |           |          | シートの\ |
   |    |           |           |           |          | 登録状況\ |
   |    |           |           |           |          | 、実行ロ\ |
   |    |           |           |           |          | グを参照\ |
   |    |           |           |           |          | します。  |
   +----+-----------+-----------+-----------+----------+-----------+

|
.. image:: collect/image7.png
   :alt: 作業管理画面
   :width: 6.00372in
   :height: 2.87662in

**図** **3.1‑1作業管理画面**

収集機能の利用手順
==================

| 収集機能の利用手順について説明します

作業フロー
----------

| 収集機能の実施における標準的なフローは以下のとおりです。
| ITA Ansible-Driverの利用方法は、「利用手順マニュアル_Ansible-Driver」を参照してください。
| ITA 基本コンソールの利用方法は、「利用手順マニュアル_基本コンソール」を参照してください。



収集機能作業フロー
~~~~~~~~~~~~~~~~~~

| 以下は、Ansible-Legacyで作業を実行するまでの流れです。

.. image:: /images/ja/ansible_common/collect_flow/collect_execflow.png
   :alt: 実行フロー
   :width: 5.00372in
   :height: 3.87662in

-  作業フロー詳細と参照先

#. | 収集機能用のユーザーの作成
   | ITA管理コンソールの機器一覧の画面から、収集機能用のユーザーを登録します。
   | 登録方法は「利用手順マニュアル_管理コンソールを参照してください。

#. | 収集機能用のロールの作成

   | ITA管理コンソールのロール一覧の画面から、収集機能用のロールを登録します。
   | 登録方法は「利用手順マニュアル_管理コンソール」 を参照してください。

#. | ロール・ユーザーの紐づけ
   | ITA管理コンソールのロール・ユーザー紐付の画面から、ロールの紐づけを行います。
   | 登録方法は「利用手順マニュアル_管理コンソール」 を参照してください。

#. | 収集インターフェース情報の登録
   | Ansible共通コンソールの収集インターフェース情報の画面から、接続情報を登録します。
   | 詳細は「5.1.1 収集インターフェース情報」を参照してください。

#. | パラメータシート（ホスト/オペレーションあり）の作成
   | メニュー作成コンソールのメニュー定義/作成の画面からのパラメータシートを作成します。
   | 詳細は「利用手順マニュアル_メニュー作成機能」を参照してください。

#. | 収集項目値管理の登録
   | Ansible共通コンソールの収集項目値管理の画面から、ソースファイルとパラメータシートの項目の紐付情報の登録をします。
   | 詳細は「5.1.2収集項目値管理」を参照してください。

#. | 作業準備
   | 作業実行のための準備を行います。
   | 詳細は、「利用手順マニュアル_Ansible-Driver」、「利用手順マニュアル_Symphony」、「利用手順マニュアル_Conductor」を参照してください。

#. | 作業実行
   | 実行日時、投入オペレーション、Movement、ワークフローを選択し処理の実行を指示します。
   | 実行について「利用手順マニュアル_Ansible-Driver」、「利用手順マニュアル_Symphony」、「利用手順マニュアル_Conductor」を参照してください。

#. | 収集機能実行
   | 作業実行が完了した作業Noを収集機能の対象として、パラメータシートへの登録処理を実施します。
   | 詳細は「 5.3 BackYardコンテンツ」を参照してください。

#. | 収集状況確認
   | Ansible-Legacy/Ansible-Pioneer/Ansible-LegacyRoleコンソールの作業管理の画面では、完了した作業の収集状態の確認、ログファイルがDL可能です。
   | 詳細は「5.2.1収集状況の確認」を参照してください。


収集機能・操作方法説明
======================

| 本章では、収集機能で利用する各コンソールの機能について説明します。
| 登録方法の詳細は、関連マニュアルの「利用手順マニュアル_基本コンソール」をご参照下さい。

Ansible 共通コンソール
----------------------

| 本節では、Ansible共通コンソールでの操作について記載します。

収集インターフェース情報
~~~~~~~~~~~~~~~~~~~~~~~~

#. | [収集インターフェース情報]では、収集機能で利用するITAの標準RESTAPIを利用する為、RESTAPIアクセス用の接続インターフェース情報の更新を行います。

   ..  image:: collect/image10.png
       :alt: サブメニュー画面（収集インターフェース情報）
       :width: 5.65382in
       :height: 2.70023in

   **図** **5.1-1サブメニュー画面（収集インターフェース情報）**

#. | 「一覧」-「更新」ボタンより、収集インターフェース情報の登録を行います。

   ..  image:: collect/image11.png
       :alt: 更新画面（収集インターフェース情報）
       :width: 5.475in
       :height: 0.70833in

   **図** **5.1-2 更新画面（収集インターフェース情報)**

#. | 収集インターフェース情報画面の項目一覧は以下のとおりです。
   | 収集インターフェース情報が未登録または、複数レコード登録されている状態で作業実行した場合、\ **収集機能によるパラメータシートへの登録はされません**\ 。

.. table:: 表 5.1-1 登録画面項目一覧（インタフェース情報）

   +-------------+-------------+----------+-------------+-------------+
   | 項目        | 説明        | 入力\    | 入力形式    | 制約事項    |
   |             |             | 必須     |             |             |
   +=============+=============+==========+=============+=============+
   | ホスト名    | 使\         | 〇       | 手動入力    |             |
   |             | 用するホス\ |          |             |             |
   |             | ト名を入力  |          |             |             |
   |             |             |          |             |             |
   |             | 初期値\     |          |             |             |
   |             | :localhost  |          |             |             |
   +-------------+-------------+----------+-------------+-------------+
   | IP          | 使用す\     | 〇       | 手動入力    |             |
   |             | るIPを入力  |          |             |             |
   |             |             |          |             |             |
   |             | 初期値      |          |             |             |
   |             | :127.0.0.1  |          |             |             |
   +-------------+-------------+----------+-------------+-------------+
   | R\          | 使用す\     |          | 手動入力    | ※1          |
   | ESTユーザー | るITAユーザ\|          |             |             |
   |             | ーのログイ\ |          |             |             |
   |             | ンIDを入力  |          |             |             |
   +-------------+-------------+----------+-------------+-------------+
   | RES\        | 使用\       |          | 手動入力    |             |
   | Tパスワード | するITAユー\|          |             |             |
   |             | ザーのログ\ |          |             |             |
   |             | インパスワ\ |          |             |             |
   |             | ードを入力  |          |             |             |
   +-------------+-------------+----------+-------------+-------------+
   | REST方式    | ホスト名、\ | 〇       | リスト選択  |             |
   |             | IPのどちら\ |          |             |             |
   |             | か使用する\ |          |             |             |
   |             | ものを選択\ |          |             |             |
   |             |             |          |             |             |
   |             | -  IP       |          |             |             |
   |             |             |          |             |             |
   |             | -  ホスト名 |          |             |             |
   +-------------+-------------+----------+-------------+-------------+
   | プロトコル  | 使用\       | 〇       | 手動入力    |             |
   |             | するプロト\ |          |             |             |
   |             | コルを入力  |          |             |             |
   |             |             |          |             |             |
   |             | 初\         |          |             |             |
   |             | 期値:http   |          |             |             |
   +-------------+-------------+----------+-------------+-------------+
   | ポート      | 使用するポ\ | 〇       | 手動入力    |             |
   |             | ートを入力  |          |             |             |
   |             |             |          |             |             |
   |             | 初期値:80   |          |             |             |
   +-------------+-------------+----------+-------------+-------------+
   | 備考        | 自由記\     | ー       | 手動入力    |             |
   |             | 述欄です。  |          |             |             |
   +-------------+-------------+----------+-------------+-------------+

| ※1 RESTユーザーに入力されたユーザーは、以下が必須にとなります。

- |  ユーザーが所属しているロールが、作成されたパラメータシートのメニューのアクセス権/アクセス許可ロールをもっている。
- |  メニューのロール情報にて、ユーザーに紐づくロールがメンテナンス可である。

| ユーザー、ロールの作成、紐付、について「利用手順マニュアル_管理コンソール」を参照してください。


収集項目値管理
~~~~~~~~~~~~~~

#. | [収集項目値管理]では、収集項目とパラメータシートの項目の紐付設定を行います。

   .. image:: collect/image12.png
      :alt: サブメニュー画面（収集項目値管理）
      :width: 5.74716in
      :height: 2.75357in

   **図** **5.1-3サブメニュー画面（収集項目値管理）**

#. | 「一覧」-「登録開始」ボタンより、収集項目の登録を行います。

   .. image:: collect/image13.png
      :alt: 登録画面（収集項目値管理）
      :width: 5.47222in
      :height: 0.85139in

   **図** **5.1-4 登録画面（収集項目値管理）**

#. | 収集項目値管理画面の項目一覧は以下のとおりです。

   .. table:: 表 5.1-1 登録画面項目一覧（収集項目値管理）
   
      +-----------------------+-----------+-----------+-----------+-----------+
      | 項目                  | 説明      | 入力\     | 入\       | 制\       |    
      |                       |           | 必須      | 力形式    | 約事項    |    
      +===========+===========+===========+===========+===========+===========+
      | 収集項\   | バ\       | ソ\       | 〇        | リ\       |           |
      | 目(FROM)  | ース形式  | ースファ\ |           | スト選択  |           |
      |           |           | イルのフ\ |           |           |           |
      |           |           | ァイル形\ |           |           |           |
      |           |           | 式を選択  |           |           |           |
      |           +-----------+-----------+-----------+-----------+-----------+
      |           | PREFIX(フ\| ソース\   | 〇        | 手動入力  | ※1        |
      |           | ァイル名) | ファイル\ |           |           |           |
      |           |           | の拡張子\ |           |           |           |
      |           |           | を除いた\ |           |           |           |
      |           |           | ファイル\ |           |           |           |
      |           |           | 名を入力  |           |           |           |
      |           +-----------+-----------+-----------+-----------+-----------+
      |           | 変数名    | 変数\     | 〇        | 手動入力  | ※1        |
      |           |           | 名を入力  |           |           |           |
      |           +-----------+-----------+-----------+-----------+-----------+
      |           | メン\     | 変数が\   |           | 手動入力  | ※1        |
      |           | バー変数  | 、複数具\ |           |           |           |
      |           |           | 体値、多\ |           |           |           |
      |           |           | 段変数の\ |           |           |           |
      |           |           | 場合入力  |           |           |           |
      +-----------+-----------+-----------+-----------+-----------+-----------+
      | パラ\     | メニュー\ | メ\       | 〇        | リ\       |           |
      | メータシ  | グループ  | ニュー作\ |           | スト選択  |           |
      | ート(TO)  |           | 成機能で\ |           |           |           |
      |           |           | 作成され\ |           |           |           |
      |           |           | たメニュ\ |           |           |           |
      |           |           | ーの一覧\ |           |           |           |
      |           |           | から選択  |           |           |           |
      |           |           |           |           |           |           |
      |           |           | グルー\   |           |           |           |
      |           |           | プ名：メ\ |           |           |           |
      |           |           | ニュー名  |           |           |           |
      |           +-----------+           |           |           |           |
      |           | メニュー  |           |           |           |           |
      |           +-----------+-----------+-----------+-----------+-----------+
      |           | 項目      | 項\       | 〇        | リ        | ※2        |
      |           |           | 目を選択  |           | スト選択  |           |
      +-----------+-----------+-----------+-----------+-----------+-----------+

| ※1 ファイル名、変数、メンバー変数入力値の例
| ※2 同一の「パラメータシート(TO)-メニューグループ：メニュー-項目」に対して、複数の「PREFIX(ファイル名)-変数名」を設定している場合、ファイル順に処理が実行されます。詳しくは「7.2収集実行例」参照。

| ■e.g.) 通常変数の構造の変数の場合 

.. code-block:: yaml
   :name: SAMPLE.yml  

   ■ファイル名: SAMPLE.yml
   ■ファイルの内容 

   VAR_sample_config_1: yes
   VAR_sample_config_2: test_parameter
   
   ■収集値項目管理の収集項目(FROM)の入力可能な値

   PREFIX(ファイル名): SAMPLE 
   変数名： VAR_sample_config_1 
            VAR_sample_config_2 


.. 見栄えが悪そうだったため上記に変更(念のため下記を残し)
.. +-----------------------------------------------+
   | e.g.) 通常変数の構造の変数の場合              |
   |                                               |
   | ■ファイル名: SAMPLE.yml                       |
   |                                               |
   | ■ファイルの内容                               |
   |                                               |
   | VAR_sample_config_1: yes                      |
   |                                               |
   | VAR_sample_config_2: test_parameter           |
   |                                               |
   | ■収集値項目管理の収集項目(FROM)の入力可能な値 |
   |                                               |
   | PREFIX(ファイル名): SAMPLE                    |
   |                                               |
   | 変数名： VAR_sample_config_1          　       |
   |                                               |
   |          VAR_sample_config_2                  |
   +-----------------------------------------------+

| ■ e.g.) 複数具体値の構造の変数の場合


.. code-block:: yaml
   :name: SAMPLE_2.yml

   ■ファイル名: SAMPLE_2.yml 
   ■ファイルの内容 

   VAR_sample2_conf:
     - SAMPLE1
     - SAMPLE2
     - SAMPLE3

   ■収集値項目管理の収集項目(FROM)の入力可能な値
   PREFIX(ファイル名): SAMPLE_2 
   変数名： VAR_sample2_conf 
   メンバー変数： [0] 
                 [1] 
                 [2] 

.. +-----------------------------------------------+
   | e.g.) 複数具体値の構造の変数の場合            |
   |                                               |
   | ■ファイル名：SAMPLE_2.yml                     |
   |                                               |
   | ■ファイルの内容                               |
   |                                               |
   | VAR_sample2_conf:                             |
   |                                               |
   | - SAMPLE1                                     |
   |                                               |
   | - SAMPLE2                                     |
   |                                               |
   | - SAMPLE3                                     |
   |                                               |
   | ■収集値項目管理の収集項目(FROM)の入力可能な値 |
   |                                               |
   | PREFIX(ファイル名)： SAMPLE_2                 |
   |                                               |
   | 変数名： VAR_sample2_conf                     |
   |                                               |
   | メンバー変数： [0]                            |
   |                                               |
   | [1]                                           |
   |                                               |
   | [2]                                           |
   +-----------------------------------------------+


| ■ e.g.) 複数具体値の構造の変数の場合 

.. code-block:: yaml
   :name: RH_sshd.yml 

   ■ファイル名: RH_sshd.yml
   ■ファイルの内容 

   VAR_RH_sshd_config: 
     - key: PermitRootLogin 
       value: yes
     - key: PasswordAuthentication 
       value: no

    ■収集値項目管理の収集項目(FROM)の入力可能な値
    PREFIX(ファイル名): RH_sshd 
    変数名： VAR_RH_sshd_config:
    メンバー変数： [0].key 
                  [0].value
                  [1].key
                  [1].value 
                  

.. +-----------------------------------------------+
   | e.g.) 複数具体値の構造の変数の場合            |
   |                                               |
   | ■ファイル名：RH_sshd.yml                      |
   |                                               |
   | ■ファイルの内容                               |
   |                                               |
   | VAR_RH_sshd_config:                           |
   |                                               |
   | - key: PermitRootLogin                        |
   |                                               |
   | value: yes                                    |
   |                                               |
   | - key: PasswordAuthentication                 |
   |                                               |
   | value: no                                     |
   |                                               |
   | ■収集値項目管理の収集項目(FROM)の入力可能な値 |
   |                                               |
   | PREFIX(ファイル名)： RH_sshd                  |
   |                                               |
   | 変数名： VAR_RH_sshd_config:                  |
   |                                               |
   | メンバー変数： [0].key                        |
   |                                               |
   | [0].value                                     |
   |                                               |
   | [1].key                                       |
   |                                               |
   | [1].value                                     |
   +-----------------------------------------------+

| ■e.g.)複数具体値の構造の変数の場合2

.. code-block:: yaml
   :name: RH_snmp.yml

   ■ファイル名: RH_snmp.yml
   ■ファイルの内容 

   VAR_RH_snmpd_info: 
     com2sec: 
       - sec_name: "testsec"
         source: "192.168.1.0/24"
         community: "public"
       - sec_name: "local"
         source: "localhost"
         community: "private"

   ■収集値項目管理の収集項目(FROM)の入力可能な値
   PREFIX(ファイル名): RH_snmp 
   変数名： VAR_RH_snmp_config: 
   メンバー変数： com2sec[0].sec_name 
                 com2sec[0].source
                 com2sec[0].community 
                 com2sec[1].sec_name] 
                 com2sec[1].source 
                 com2sec[1].community

.. +-----------------------------------------------+
   | e.g.) 複数具体値の構造の変数の場合2           |
   |                                               |
   | ■ファイル名：RH_snmp.yml                      |
   |                                               |
   | ■ファイルの内容                               |
   |                                               |
   | VAR_RH_snmpd_info:                            |
   |                                               |
   | com2sec:                                      |
   |                                               |
   | - sec_name: "testsec"                         |
   |                                               |
   | source: "192.168.1.0/24"                      |
   |                                               |
   | community: "public"                           |
   |                                               |
   | - sec_name: "local"                           |
   |                                               |
   | source: "localhost"                           |
   |                                               |
   | community: "private"                          |
   |                                               |
   | ■収集値項目管理の収集項目(FROM)の入力可能な値 |
   |                                               |
   | PREFIX(ファイル名)： RH_snmp                  |
   |                                               |
   | 変数名： VAR_RH_snmp_config:                  |
   |                                               |
   | メンバー変数： com2sec[0].sec_name            |
   |                                               |
   | com2sec[0].source                             |
   |                                               |
   | com2sec[0].community                          |
   |                                               |
   | com2sec[1].sec_name]                          |
   |                                               |
   | com2sec[1].source                             |
   |                                               |
   | com2sec[1].community                          |
   +-----------------------------------------------+

Ansible-Legacy、Ansible-Pioneer、Ansible-LegacyRoleコンソール
-------------------------------------------------------------

収集状況の確認
~~~~~~~~~~~~~~

| 各コンソール（Ansible-Legacy/Ansible-Pioneer/Ansible-LegacyRole）の作業管理の画面では、完了した作業の収集状態の確認、ログファイルがDL可能です。

.. image:: collect/image7.png
   :alt: 作業管理画面 
   :width: 5.78688in
   :height: 2.77273in

**図** **5.2-1作業管理画面**

.. table:: 表 5.2-1 作業管理画面収集状況詳細

   +------------+--------------------------------------------+----------+
   | 項目       | 説明                                       | 備考     |
   +============+============================================+==========+
   | ステータス | 収集機能の実行状況の表示                   | ※        |
   |            |                                            |          |
   |            | 対\                                        |          |
   |            | 象外：収集機能対象外　（対象ファイルなし） |          |
   |            |                                            |          |
   |            | 収集済み：収集機能実施済み                 |          |
   |            |                                            |          |
   |            | 収集済み（\                                |          |
   |            | 通知あり）：登録/更新中に不備があった場合  |          |
   |            |                                            |          |
   |            | 収集エラー：Moveme\                        |          |
   |            | ntのオペレーション、ホストに不備がある場合 |          |
   +------------+--------------------------------------------+----------+
   | 収集ログ   | 収集機能実行のログをダウンロード           |          |
   +------------+--------------------------------------------+----------+


.. table:: 表 5.2-2 収集状況詳細

   +----------+----------+-------------------------------------------+
   | 作\      | 収集機\  | 収\                                       |
   | 業状態   | 能対象   | 集状況                                    |
   +----------+----------+----------+----------+----------+----------+
   | ステ\    |          | 対象フ\  | ステ\    | 収\      | 備考     |
   | ータス   |          | ァイル   | ータス   | 集ログ   |          |
   +==========+==========+==========+==========+==========+==========+
   | 完了以外 | なし     | 対象外   | 空       | 空       |          |
   +----------+----------+----------+----------+----------+----------+
   | 完了以外 | あり     | 対象外   | 空       | 空       |          |
   +----------+----------+----------+----------+----------+----------+
   | 完了     | なし     | 対象     | 対象外   | ログファ\|          |
   |          |          |          |          | イルあり |          |
   +----------+----------+----------+----------+----------+----------+
   | 完了     | あり     | 対象     | 収集済み | ログファ\|          |
   |          |          |          |          | イルあり |          |
   +----------+----------+----------+----------+----------+----------+
   | 完了     | あり     | 対象     | 収集\    | ログファ\|          |
   |          |          |          | 済み(通\ | イルあり |          |
   |          |          |          | 知あり） |          |          |
   +----------+----------+----------+----------+----------+----------+



| ※ステータスの表記について

-  | 作業状態が完了でない場合、収集機能対象外の為、収集状況は更新されないため、空のままとなります。
-  | 作業状態が完了で、収集対象ファイルが存在しない場合、ステータスは収集済み、収集ログは空の状態となります。
-  | 収集インターフェース情報、設定項目値管理、メニューのアクセス権/アクセス許可ロールの不備により、RESTAPIの登録処理が失敗した場合でも収集済み（通知あり）となります。詳細は、収集ログ内を参照。

| **ログファイル出力内容例**


| ■ e.g.) ログファイル出力内容例 (登録処理成功)   

.. code-block:: bash
   :name: ログファイル出力内容例

   2020-11-13 13:51:02 Collect START ( ホスト名:ita-sample ファイル名:RH_snmpd )
   2020-11-13 13:51:02 REST DATA ( ホスト名: ita-sample メニューID: 0000000004 オペレーションNO: 1 )
   Array
   (
       [0] => http://127.0.0.1:80/default/menu/07_rest_api_ver1.php?no=0000000004
       [1] => [["更新","","3","ita-sample","","","","","","2023\/10\/26 16:35_1:OP001","Root <root@localhost> (configure \/etc\/snmp\/snmp.local.conf)","Unknown (edit \/etc\/snmp\/snmpd.conf)","public","notConfigUser","","","T_20201111115557819037",""]]
       [2] => {"status":"SUCCEED","resultdata":{"LIST":{"NORMAL":{"register":{"name":"登録","ct":0},"update":{"name":"更新","ct":1},"delete":{"name":"廃止","ct":0},"revive":{"name":"復活","ct":0},"error":{"name":"エラー","ct":0}},"RAW":[["000","200",""]]}}}
   )
   2020-11-13 13:51:02 Collect END ( ホスト名:ita-sample ファイル名:RH_snmpd )                                                  

.. +----------------------------------------------------------------------+
   | e.g.) ログファイル出力内容例 (登録処理成功)                          |
   |                                                                      |
   | 2020-11-13 13:51:02 Collect START ( ホスト名:ita-sample              |
   | ファイル名:RH_snmpd )                                                |
   |                                                                      |
   | 2020-11-13 13:51:02 REST DATA ( ホスト名: ita-sample メニューID:     |
   | 0000000004 オペレーションNO: 1 )                                     |
   |                                                                      |
   | Array                                                                |
   |                                                                      |
   | (                                                                    |
   |                                                                      |
   | [0] =>                                                               |
   | http://127.0.0.1:80/default/menu/07_rest_api_ver1.php?no=0000000004  |
   |                                                                      |
   | [1] => [["更新","","3","ita-sample","","","","","","2023\/10\/26     |
   | 16:35_1:OP001","Root <root@localhost> (configure                     |
   | \\/etc\/snmp\/snmp.local.conf)","Unknown (edit                       |
   | \\/etc\/snmp\/snmpd                                                  |
   | .conf)","public","notConfigUser","","","T_20201111115557819037",""]] |
   |                                                                      |
   | [2] =>                                                               |
   | {"status":"SUCCEED","resultdata":{"LIST"                             |
   | :{"NORMAL":{"register":{"name":"登録","ct":0},"update":{"name":"更新 |
   | ","ct":1},"delete":{"name":"廃止","ct":0},"revive":{"name":"復活","  |
   | ct":0},"error":{"name":"エラー","ct":0}},"RAW":[["000","200",""]]}}} |
   |                                                                      |
   | )                                                                    |
   |                                                                      |
   | 2020-11-13 13:51:02 Collect END ( ホスト名:ita-sample                |
   | ファイル名:RH_snmpd )                                                |
   +----------------------------------------------------------------------+


| ■ e.g.) ログファイル出力内容例 (登録処理失敗) 

.. code-block:: bash
   :name: ログファイル出力内容例 (登録処理失敗) 

   2020-11-06 13:32:52 Collect START ( ホスト名:ita-sample ファイル名:RH_snmpd )
   2020-11-06 13:32:52 [処理]RESTアクセスに失敗しました。
   Array
   (
       [0] => http://127.0.0.1:80/default/menu/07_rest_api_ver1.php?no=0000000005
       [1] => [["登録","","","ita-sample","","","","","","2023\/10\/26 16:35_1:OP001","Root <root@localhost>(configure \/etc\/snmp\/snmp.local.conf)","Unknown (edit \/etc\/snmp\/snmpd.conf)","public","notConfigUser","","","",""]]
       [2] => {"Error":メンテナンス権限がありません。","Exception":"Generic error","StackTrace":"none"}
   )
   2020-11-06 13:32:52 Collect END ( ホスト名:ita-sample ファイル名:RH_snmpd )



.. +----------------------------------------------------------------------+
   | e.g.) ログファイル出力内容例 (登録処理失敗)                          |
   |                                                                      |
   | 2020-11-06 13:32:52 Collect START ( ホスト名:ita-sample              |
   | ファイル名:RH_snmpd )                                                |
   |                                                                      |
   | 2020-11-06 13:32:52 [処理]RESTアクセスに失敗しました。               |
   |                                                                      |
   | Array                                                                |
   |                                                                      |
   | (                                                                    |
   |                                                                      |
   | [0] =>                                                               |
   | http://127.0.0.1:80/default/menu/07_rest_api_ver1.php?no=0000000005  |
   |                                                                      |
   | [1] => [["登録","","","ita-sample","","","","","","2023\/10\/26      |
   | 16:35_1:OP001","Root <root@localhost>(configure                      |
   | \\/etc\/snmp\/snmp.local.conf)","Unknown (edit                       |
   | \\/etc\/snmp\/snmpd.conf)","public","notConfigUser","","","",""]]    |
   |                                                                      |
   | [2] => {"Error":メンテナンス権限がありません。","Exception":"Generic |
   | error","StackTrace":"none"}                                          |
   |                                                                      |
   | )                                                                    |
   |                                                                      |
   | 2020-11-06 13:32:52 Collect END ( ホスト名:ita-sample                |
   | ファイル名:RH_snmpd )                                                |
   +----------------------------------------------------------------------+
 
| ■ e.g.) ログファイル出力内容例 (対象外) 

.. code-block:: bash
   :name: e.g.) ログファイル出力内容例 (対象外) 
  
   2020-11-05 16:55:31 [処理]対象機器が登録されていないか、廃止されているため、登録、更新処理をスキップ(ホスト名:ita-test) 


.. +----------------------------------------------------------------------+
   | e.g.) ログファイル出力内容例 (対象外)                                |
   |                                                                      |
   | 2020-11-05 16:55:31                                                  |
   | [処理]対象機器が登録されていない                                     |
   | か、廃止されているため、登録、更新処理をスキップ(ホスト名:ita-test)  |
   +----------------------------------------------------------------------+

BackYardコンテンツ
------------------

#.  パラメータシートへの登録処理の概要
   
    #. | 収集インターフェース情報の取得
    
    #. | 正常に完了した作業の一覧を取得 
       | 収集対象ステータス： 完了

    #. | 収集対象作業Noから以下の情報を取得
       
       -  オペレーション情報
       -  対象ホスト
       -  対象ソースファイル

    #. | 対象のホストが機器一覧に登録されているか問い合わせ

       | 登録： 収集対象
       | 未登録： 対象外

    #. | 対象ソースファイルと収集項目値管理から対象パラメータシートのメニューIDを取得
       | ※対象ソースファイルが複数ある場合、ファイル名の昇順で処理を実行します。

    #. | (1)～（4）の情報からRESTAPIのパラメータを生成

       | 対象のメニューIDに対して、データの問い合わせを実施し、RESTAPIの実行種別を判定
       | 登録：　一意のオペレーション、ホスト組み合わせのデータが登録されていない
       | 更新：　一意のオペレーション、ホスト組み合わせのデータが登録されている

    #. | ITA標準RESTAPI機能にて、データの登録/更新を実施します。

    #. | 作業Noに収集状況のステータスを更新



| なお、パラメータシートへのデータ登録のタイミングは自動プロセスの起動周期に依存します。
| 起動周期の変更については、後述「**6.2メンテナンス方法について**\ 」を参照してください。
| 登録・更新されたレコードのアクセス権/アクセス許可ロールは、収集対象の作業結果のアクセス権/アクセス許可ロールを継承します。
| 対象の作業結果については、別紙「Exastro-ITA_利用手順マニュアル_Ansible-driver」を参照してください。

運用操作
========

| 本機能を活用する操作は、クライアントPCのブラウザ画面からのユーザー利用による入力だけでなく、システム運用・保守による操作もあります。用意している運用・保守の操作は次のとおりです。

メンテナンス
------------

| 収集機能のプロセスの開始/停止/再起動に必要なファイルは以下となります。

.. list-table:: メンテナンス
   :widths: 10 10
   :header-rows: 1
   :align: left

   * - 説明
     - 対象ファイル名
   * - | パラメータ自動登録
       | 作業実行が完了した、作業結果から、設定項目値管理に登録した情報を元に、パラメータシートへの登録を行う。
     - ky_std_synchronize-Collector.service


| 対象ファイルは「/usr/lib/systemd/system」に格納されています。
| プロセス起動/停止/再起動の方法は次の通りです。
| root権限でコマンドを実行してください。

#. | プロセス起動

   .. code-block:: bash

      # systemctl start ky_std_synchronize-Collector.service

#. | プロセス停止

   .. code-block:: bash

      # systemctl stop ky_std_synchronize-Collector.service

#. | プロセス再起動

   .. code-block:: bash

      # systemctl restart ky_std_synchronize-Collector.service


| 各対象ファイル名に置き換えて起動/停止/再起動を行ってください。


メンテナンス方法について
------------------------

| ①　NORMALレベルへの変更
| 以下のファイルの8行目「DEBUG」を「NORMAL」に書き換えます。
| ログレベル設定ファイル：:file:`<インストールディレクトリ>/ita-root/confs/backyardconfs/ita_env`

|  ②　DEBUGレベルへの変更
| 以下のファイルの8行目「NORMAL」を「DEBUG」に書き換えます。
| ログレベル設定ファイル：:file:`<インストールディレクトリ>/ita-root/confs/backyardconfs/ita_env`

|  ③ 起動周期の変更
| 各対象ファイルのExecStartの5番目のパラメータを変更します。（単位:秒）
| 例外を除き起動周期はデフォルト値の使用をしてください。

.. code-block:: bash 

   ExecStart=/bin/sh ${ITA_ROOT_DIR}/backyards/common/ky_loopcall-php-procedure.sh /bin/php /bin/php ${ITA_ROOT_DIR}/backyards/terraform_driver/ky_terraform_execute-workflow.php ${ITA_ROOT_DIR}/logs/backyardlogs 5 ${ITA_LOG_LEVEL} > /dev/null 2>&1

| 書き換え後、プロセス再起動(restart)後に有効になります。
| ログファイルの出力先：:file:`<インストールディレクトリ>/ita-root/logs/backyardlogs`


付録
====

参考資材
--------
       
| 以下、IaC(Playbook、Role)の参考例となります。

#. |  Ansible Playbook Collection（OS設定収集）
   | https://github.com/exastro-suite/playbook-collection-docs/blob/master/README.ja.md

#. | Ansibleコンフィグ取得、パラメータ生成Playbook

   .. code-block:: yaml
      :name: makeYml_Ansible.yml
      :caption: makeYml_Ansible.yml

      - name: make yaml file
        blockinfile:
          create: yes
          mode: 0644
          insertbefore: EOF
          marker: ""
          dest: "/tmp/Ansible_conf.yml"
          content: |
            ansible_architecture: {{ ansible_architecture }}
            ansible_bios_version: {{ ansible_bios_version }}
            ansible_default_ipv4__address: {{ ansible_default_ipv4.address }}
            ansible_default_ipv4__interface: {{ ansible_default_ipv4.interface }}
            ansible_default_ipv4__network: {{ ansible_default_ipv4.network }}
            ansible_distribution: {{ ansible_distribution }}
            ansible_distribution_file_path: {{ ansible_distribution_file_path }}
            ansible_distribution_file_variety: {{ ansible_distribution_file_variety }}
            ansible_distribution_major_version: {{ ansible_distribution_major_version }}
            ansible_distribution_release: {{ ansible_distribution_release }}
            ansible_distribution_version: {{ ansible_distribution_version }}
            ansible_machine: {{ ansible_machine }}
            ansible_memtotal_mb: {{ ansible_memtotal_mb }}
            ansible_nodename: {{ ansible_nodename }}
            ansible_os_family: {{ ansible_os_family }}
            ansible_pkg_mgr: {{ ansible_pkg_mgr }}
            ansible_processor_cores: {{ ansible_processor_cores }}
            ansible_processor_count: {{ ansible_processor_count }}
            ansible_processor_threads_per_core: {{ ansible_processor_threads_per_core }}
            ansible_processor_vcpus: {{ ansible_processor_vcpus }}
            ansible_product_name: {{ ansible_product_name }}
            ansible_product_serial: {{ ansible_product_serial }}
            ansible_product_uuid: {{ ansible_product_uuid }}
            ansible_product_version: {{ ansible_product_version }}
            ansible_python__executable: {{ ansible_python.executable }}
            ansible_python_version: {{ ansible_python_version }}
            ansible_service_mgr: {{ ansible_service_mgr }}
            ansible_php_config: php.ini
      
      - name: Copy the make yaml file to local
        fetch:
          src: "/tmp/Ansible_conf.yml"
          dest: "{{ __parameter_dir__ }}/{{ inventory_hostname }}/"
          flat: yes
      
      - name: get php config
        fetch:
          src: /etc/php.ini
          dest:  "{{ __parameters_file_dir__ }}/{{ inventory_hostname }}/"
          flat: yes



| ※　makeYml_Ansible.yml実行して、収集対象のソースファイル(yaml)を生成する場合、gather_factsを有効にする必要があります。
| 「Ansible-Legacy」-「Movement一覧」編集時、「ヘッダーセクション」に以下を記載する。
| 設定変更については、「利用手順マニュアルAnsible-driver」を参照してください。


| ■e.g) gather_facts有効設定例


.. code-block:: yaml

   - hosts: all    
     remote_user: "{{ __loginuser__ }}"
     gather_facts: yes 
     become: yes


収集実行例
----------

複数ファイルの同一メニューを対象とした場合
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

| 収集項目値管理にて、一つの「メニュー-項目」に対して、複数の「PREFIX(ファイル名)-変数名」の設定をしている場合、対象ホストの収集対象ディレクトリ内に、該当する複数のソースファイルがある場合の収集処理の例について記載します。


.. code-block:: bash
   :name: 収集対象ファイル
   :caption: 収集対象ファイル

   【上位ディレクトリ】
      |-  _parameters           
          |-  ita-sample01
              |-  SAMPLE_01.yml   
              |-  SAMPLE_02.yml 


| **■ 収集項目値管理設定**

| ■ファイル名：SAMPLE_01.yml ,SAMPLE_02.yml 

.. list-table:: ファイルの内容
   :widths: 10 10
   :header-rows: 1
   :align: left
   
   * - SAMPLE_01.yml
     - SAMPLE_02.yml
   * - | VAR_sample_config_1: 1
       | VAR_sample_config_2: 2
       | VAR_sample_config_3: 3
     - | VAR_sample_config_1: “A”
       | VAR_sample_config_B: “B”
       | VAR_sample_config_X: “X”
    

| **■ 収集値項目管理の設定と対象メニュー項目の収集例**  

| e.g) 収集値項目管理の設定と対象メニュー-項目   

.. image:: collect/image14.png
   :alt: メニュー項目
   :width: 6.11686in
   :height: 2.26773in
|
.. image:: collect/image15.png
   :alt: メニュー項目
   :width: 6.11686in
   :height: 2.26773in

| **■対象ファイル、収集値項目管理の設定内容に沿って、ファイル単位に収集処理を実行**

1. SAMPLE_01.yml の登録処理（登録）
   
.. image:: collect/image16.png
   :alt: SAMPLE_01.yml の登録処理（登録）
   :width: 6.00785in
   :height: 0.51786in  

2. SAMPLE_02.yml の登録処理（更新）

.. image:: collect/image17.png
   :alt: SAMPLE_02.yml の登録処理（更新）
   :width: 6in
   :height: 0.52304in 

3. 収集機能完了後のレコードの状態

.. image:: collect/image15.png
   :alt: 収集機能完了後のレコードの状態
   :width: 6.06086in
   :height: 0.52834in

.. 見栄えを考えて上記に修正(不要であれば削除)
.. +----------------------------------------------------------------------+
   | ■ファイル名：SAMPLE_01.yml                                           |
   |                                                                      |
   | 　　　　　　　　 SAMPLE_02.yml                                       |
   |                                                                      |
   | ■ファイルの内容                                                      |
   |                                                                      |
   | ====================== ========================                      |
   | SAMPLE_01.yml　        SAMPLE_02.yml                                 |
   | ====================== ========================                      |
   | VAR_sample_config_1: 1 VAR_sample_config_1: “A”                      |
   |                                                                      |
   | VAR_sample_config_2: 2 VAR_sample_config_B: “B”                      |
   |                                                                      |
   | VAR_sample_config_3: 3 VAR_sample_config_X: “X”                      |
   | ====================== ========================                      |
   |                                                                      |
   | ■収集値項目管理の設定と対象メニュー項目の収集例                      |
   |                                                                      |
   | e.g) 収集値項目管理の設定と対象メニュー-項目                         |
   |                                                                      |
   | |image14|                                                            |
   |                                                                      |
   | |image15|                                                            |
   |                                                                      |
   | ■対象ファ                                                            |
   | イル、収集値項目管理の設定内容に沿って、ファイル単位に収集処理を実行 |
   |                                                                      |
   | 1. SAMPLE_01.ymlの登録処理（登録）                                   |
   |                                                                      |
   | |image16|                                                            |
   |                                                                      |
   | 2.SAMPLE_02.ymlの登録処理（更新）                                    |
   |                                                                      |
   | |image17|                                                            |
   |                                                                      |
   | 3.収集機能完了後のレコードの状態                                     |
   |                                                                      |
   | |image18|                                                            |
   +----------------------------------------------------------------------+

収集対象ファイルの値の取り扱い
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

| Yaml形式で出力された収集対象ファイルについて、パラメータシートへの登録処理時の値の取り扱いについて以下として扱います。

.. code-block:: yaml
   :name: 収集対象ファイル
   :caption: Sample.yml

   VAR_TEST: TEST
   VAR_STR_TEST1: 'TEST1'
   VAR_STR_TEST2: "TEST2"
   VAR_null: null
   VAR_NULL: NULL
   VAR_STR_null: "null"
   VAR_STR_NULL: "NULL"
   VAR_true: true
   VAR_false: false
   VAR_STR_true: "true"
   VAR_STR_false: "false"
   VAR_YES: YES
   VAR_NO: NO
   VAR_STR_YES: "YES"
   VAR_STR_NO: "NO"
   VAR_NON:
   VAR_Quotation: ''
   VAR_WQuotation: ""


| ■ 収集対象YAML(sample.yml)のキーと値

.. list-table:: 表 7-1 収集対象YAML(sample.yml)のキーと値
   :widths: 3 10 10 5
   :header-rows: 1
   :align: left

   * - No
     - キー 
     - 値
     - 備考
   * - 1
     - VAR_TEST
     - TEST
     -   
   * - 2
     - VAR_STR_TEST1 
     - 'TEST1'
     - 
   * - 3
     - VAR_STR_TEST2
     - "TEST2" 
     - 
   * - 4
     - VAR_null
     - null
     -  
   * - 5
     - VAR_NULL
     - NULL
     -
   * - 6
     - VAR_STR_null
     - "null"
     - 
   * - 7
     - VAR_STR_NULL 
     -  "NULL"
     - 
   * - 8
     - VAR_true 
     - true
     - 
   * - 9
     - VAR_false
     - false
     - 
   * - 10
     - VAR_STR_true
     -  "true"
     - 
   * - 11
     - VAR_STR_false
     - "false"
     - 
   * - 12
     - VAR_YES
     - YES
     -
   * - 13
     - VAR_NO
     - NO
     -
   * - 14
     - VAR_STR_YES 
     - "YES"  
     - 
   * - 15
     - VAR_STR_NO
     - "NO"
     - 
   * - 16
     - VAR_NON
     -  
     -
   * - 17
     - VAR_Quotation
     - '' 
     -
   * - 18
     - VAR_WQuotation
     - ""
     -  

| ■ 収集対象YAML(sample.yml)の収集

.. list-table:: 表 収集対象YAML(sample.yml)の収集
   :widths: 3 10 10 10 10
   :header-rows: 1
   :align: left

   * - No
     - 収集対象 (キー:値)
     - パラメータシート項目名 
     - RESTAPI
     - WEB画面   
   * - 1
     - VAR_TEST: TEST 
     - パラメータ/VAR_TEST 
     - "TEST"
     - TEST 
   * - 2
     - VAR_STR_TEST1: 'TEST1'
     - パラメータ/VAR_STR_TEST1 
     - "TEST1"
     - TEST1 
   * - 3
     - VAR_STR_TEST2: "TEST2"
     - パラメータ/VAR_STR_TEST2 
     - "TEST2" 
     - TEST2
   * - 4  
     - VAR_null: null 
     - パラメータ/VAR_null 
     - null
     - 
   * - 5
     - VAR_NULL: NULL 
     - パラメータ/VAR_NULL
     - null
     - 
   * - 6  
     - VAR_STR_null: "null"
     - パラメータ/VAR_STR_null 
     - "null"
     -  null
   * - 7
     - VAR_STR_NULL: "NULL"
     - パラメータ/VAR_STR_NULL
     -  "NULL" 
     -  NULL
   * - 8
     - VAR_true: true
     - パラメータ/VAR_true
     - "1"
     - 1
   * - 9
     - VAR_false: false
     - パラメータ/VAR_false
     - ""
     -   
   * - 10
     - VAR_STR_true: "true" 
     - パラメータ/VAR_STR_true 
     - "true"
     - true
   * - 11
     - VAR_STR_false: "false" 
     - パラメータ/VAR_STR_false 
     - "false"
     - false 
   * - 12 
     - VAR_YES: YES 
     - パラメータ/VAR_YES 
     - "1" 
     - 1
   * - 13
     - VAR_NO: NO 
     - パラメータ/VAR_NO 
     - ""
     -   
   * - 14
     - VAR_STR_YES: "YES" 
     - パラメータ/VAR_STR_YES
     - "YES"
     - YES
   * - 15
     - VAR_STR_NO: "NO" 
     - パラメータ/VAR_STR_NO  
     - "NO"
     - NO
   * - 16
     - VAR_NON:  
     - パラメータ/VAR_NON 
     - null
     - 
   * - 17
     - VAR_Quotation: ''
     - パラメータ/VAR_Quotation 
     - null
     - 
   * - 18
     - VAR_WQuotation: ""
     - パラメータ/VAR_WQuotation
     - null
     -  


| ※パラメータシートの値は、RESTAPIでFILTERの取得結果から、文字列に関して、””で囲った状態で記載しています。
| ※RESTAPI（FILTER）での取得結果例、WEB画面の表示結果例について記載しています。

-  対象パラメータシートの画面上の表示結果

.. image:: collect/image18.png
   :alt: 対象パラメータシートの画面上の表示結果
   :width: 6.96252in
   :height: 1.98221in

-  対象パラメータシートのRESTAPI(FILTER)での取得結果

.. code-block:: json

   {
    "status": "SUCCEED",
    "resultdata": {
        "CONTENTS": {
            "RECORD_LENGTH": 1,
            "BODY": [
                [
                    "実行処理種別",
                    "廃止",
                    "No",
                    "ホスト名",
                    "オペレーション/ID",
                    "オペレーション/オペレーション名",
                    "オペレーション/基準日時",
                    "オペレーション/実施予定日時",
                    "オペレーション/最終実行日時",
                    "オペレーション/オペレーション",
                    "パラメータ/VAR_TEST",
                    "パラメータ/VAR_STR_TEST1",
                    "パラメータ/VAR_STR_TEST2",
                    "パラメータ/VAR_null",
                    "パラメータ/VAR_NULL",
                    "パラメータ/VAR_STR_null",
                    "パラメータ/VAR_STR_NULL",
                    "パラメータ/VAR_true",
                    "パラメータ/VAR_false",
                    "パラメータ/VAR_STR_true",
                    "パラメータ/VAR_STR_false",
                    "パラメータ/VAR_YES",
                    "パラメータ/VAR_NO",
                    "パラメータ/VAR_STR_YES",
                    "パラメータ/VAR_STR_NO",
                    "パラメータ/VAR_NON",
                    "パラメータ/VAR_Quotation",
                    "パラメータ/VAR_WQuotation",
                    "アクセス権/アクセス許可ロール",
                    "備考",
                    "最終更新日時",
                    "更新用の最終更新日時",
                    "最終更新者"
                ],
                [
                    null,
                    "",
                    "1",
                    "local",
                    "1",
                    "OP01",
                    "2021/11/17 13:30",
                    "2021/11/23 16:04",
                    "2021/11/17 13:30",
                    "2021/11/23 16:04_1:OP01",
                    "TEST",
                    "TEST1",
                    "TEST2",
                    null,
                    null,
                    "null",
                    "NULL",
                    "1",
                    "",
                    "true",
                    "false",
                    "1",
                    "",
                    "YES",
                    "NO",
                    null,
                    null,
                    null,
                    "",
                    null,
                    "2021/11/17 16:04:28",
                    "T_20211117160428242847",
                    "システム管理者"
                ]
            ],
            "UPLOAD_FILE": []
            }
       }
   }
                   


複数の同一ファイル名がアップロード対象ファイルの指定例
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

| Yaml形式で出力された収集対象ファイルについて、同一ホストで、階層別で同一ファイル名を取り扱う必要がある場合に、アップロード対象ファイルの指定例について記載します。

| ■ e.g.)　収集対象ファイルのファイルパス、ディレクトリ構造 

.. code-block:: bash

   【上位ディレクトリ】
      |-  _parameters           
      |   |-  localhost           
      |       |-  SAMPLE.yml   
      |-  _parameters_file         
      |   |-  localhost           
                |-  APP001
                    |-  config                   #①
                |-  APP002
                    |-  config                   #②
                |-  APP003
                    |-  config                   #③
                |-  APP002
                    |-  config                   #④
     
     ■収集対象ファイル名：SAMPLE.yml
     ■ファイルの内容
     VAR_upload_file_1: config
     VAR_upload_file_2: ‘/<上位ディレクトリ>/_parameters_file /localhost /APP002/config’
     VAR_upload_file_3: ‘/APP002/config’
     VAR_upload_file_4: ‘/APP001/config’
     VAR_upload_file_5: ‘/APP003/APP002/config’
    

.. +----------------------------------------------------------------------+
   | e.g.)　収集対象ファイルのファイルパス、ディレクトリ構造              |
   |                                                                      |
   | 【上位ディレクトリ】                                                 |
   |                                                                      |
   | \|- \_parameters 　                                                  |
   |                                                                      |
   | \| \|- localhost 　                                                  |
   |                                                                      |
   | \| \|- SAMPLE.yml 　                                                 |
   |                                                                      |
   | \|- \_parameters_file                                                |
   |                                                                      |
   | \| \|- localhost 　                                                  |
   |                                                                      |
   | 　　　　|- APP001                                                    |
   |                                                                      |
   | 　　　　|- config #①                                                 |
   |                                                                      |
   | 　　　　|- APP002                                                    |
   |                                                                      |
   | 　　　　|- config #②                                                 |
   |                                                                      |
   | 　　　　|- APP003                                                    |
   |                                                                      |
   | 　　　　|- config #③                                                 |
   |                                                                      |
   | 　　　　 \|- APP002                                                  |
   |                                                                      |
   | 　　　　 \|- config #④                                               |
   |                                                                      |
   | ■収集対象ファイル名：SAMPLE.yml                                      |
   |                                                                      |
   | ■ファイルの内容                                                      |
   |                                                                      |
   | VAR_upload_file_1: config                                            |
   |                                                                      |
   | VAR_upload_file_2: ‘/<上位ディレクトリ>/_parameters_file /localhost  |
   | /APP002/config’                                                      |
   |                                                                      |
   | VAR_upload_file_3: ‘/APP002/config’                                  |
   |                                                                      |
   | VAR_upload_file_4: ‘/APP001/config’                                  |
   |                                                                      |
   | VAR_upload_file_5: ‘/APP003/APP002/config’                           |
   +----------------------------------------------------------------------+

| ※上位ディレクトリについては、「2.1収集対象ディレクトリ、ファイル構造」をご参照ください。
| 収集対象ファイルの内容収集時に対処となるファイルの実体は以下となります。

.. list-table:: 表 7-3 収集対象ファイルとファイルの実体
   :widths: 10 10 5
   :header-rows: 1
   :align: left

   * - 収集項目(FROM)/変数名 
     - 対象ファイル 
     - 備考
   * - VAR_upload_file_1 
     - ①、②、③、④のファイルからランダム
     -   
   * - VAR_upload_file_2
     - ②のファイルが対象
     - 
   * - VAR_upload_file_3 
     - ②、④のファイルからランダム
     -  
   * - VAR_upload_file_4 
     - ①のファイルが対象 
     - 
   * - VAR_upload_file_5 
     - ④のファイルが対象 
     - 


ファイル削除時の収集対象ファイル内の記載例
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

| ファイルアップロード項目のファイル削除する場合の収集対象ファイルの指定例について記載します。
| 削除するファイルについて対象の変数名の値を空文字として設定することで削除可能です。


| ■e.g.) ファイルアップロード項目の削除収集対象ファイルのファイルパス、ディレクトリ構造


.. code-block:: bash

   【上位ディレクトリ】
      |-  _parameters           
      |   |-  localhost           
      |       |-  SAMPLE.yml   ※ソースファイル
      |-  _parameters_file         
      |   |-  localhost 

    ■収集対象ファイル名: SAMPLE.yml
    ■ファイルの内容
    VAR_upload_file:""         ※アップロード対象ファイル
    
.. +----------------------------------------------------------------------+
   | e.g.)　                                                              |
   | ファイルア\                                                          |
   | ップロード項目の削除収集対象ファイルのファイルパス、ディレクトリ構造 |
   |                                                                      |
   | ■構造                                                                |
   |                                                                      |
   | 【上位ディレクトリ】                                                 |
   |                                                                      |
   | \|- \_parameters                                                     |
   |                                                                      |
   | \| \|- localhost                                                     |
   |                                                                      |
   | \| \|- SAMPLE.yml ※ソースファイル                                    |
   |                                                                      |
   | \|- \_parameters_file                                                |
   |                                                                      |
   | \| \|- localhost                                                     |
   |                                                                      |
   | ■収集対象ファイル名：SAMPLE.yml                                      |
   |                                                                      |
   | ■ファイルの内容                                                      |
   |                                                                      |
   | VAR_upload_file: "" ※アップロード対象ファイル                        |
   +----------------------------------------------------------------------+










 




